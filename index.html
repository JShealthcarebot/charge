<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœˆè¨˜å¸³ï½œè–ªè³‡æ‰£é™¤è©¦ç®— & è¨˜éŒ„ï¼ˆ114 ç´šè·è‡ªå‹•å¸¶å…¥ï½œåªå¡«è–ªè³‡ï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg: linear-gradient(135deg,#eaf6ff,#f6f9ff); --card: rgba(255,255,255,.8); --text:#1f2937; --muted:#6b7280; --brand:#4f46e5; --ok:#10b981; --warn:#f59e0b; --danger:#ef4444; --ring: rgba(79,70,229,.25); }
    .dark{ --bg: radial-gradient(1200px 800px at 10% 10%, #1f2937, #0b1020); --card: rgba(17,24,39,.75); --text:#e5e7eb; --muted:#9ca3af; --brand:#8b5cf6; --ok:#34d399; --warn:#fbbf24; --danger:#f87171; --ring: rgba(139,92,246,.25); color-scheme: dark; }
    *{box-sizing:border-box}
    body{ margin:0;min-height:100dvh;display:flex;flex-direction:column;gap:16px; font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text); }
    header{ position:sticky;top:0;z-index:5; backdrop-filter:saturate(150%) blur(10px); background:transparent; padding:16px 12px 0; }
    .wrap{max-width:980px;margin:0 auto;padding:12px;}
    .title{ display:flex;align-items:center;gap:12px;flex-wrap:wrap; }
    .title h1{font-size:22px;margin:0;font-weight:700;letter-spacing:.5px}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;background:var(--card);box-shadow:0 6px 24px rgba(0,0,0,.07);border:1px solid rgba(0,0,0,.05)}

    .card{ background:var(--card);border:1px solid rgba(255,255,255,.35); border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.12); backdrop-filter: blur(12px) saturate(160%); padding:16px;margin:8px 0;position:relative;overflow:hidden; }
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:720px){.row{grid-template-columns:1.25fr .75fr}}

    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:var(--muted)}
    input,select{height:42px;padding:0 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.7);outline:none;color:inherit}
    .dark input,.dark select{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.08)}
    input:focus,select:focus{box-shadow:0 0 0 6px var(--ring);border-color:transparent}

    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .round-btn{ display:inline-flex;align-items:center;justify-content:center;gap:8px; height:46px;padding:0 18px;border-radius:999px;border:0;cursor:pointer; background:linear-gradient(135deg,var(--brand),#22c1c3); color:white;font-weight:600; box-shadow:0 10px 24px rgba(79,70,229,.35); transform:translateY(0); transition:.2s transform cubic-bezier(.2,.8,.2,1), filter .2s; }
    .round-btn:hover{transform:translateY(-2px)} .round-btn:active{transform:translateY(0)}
    .danger{background:linear-gradient(135deg,var(--danger),#ef5da8); box-shadow:0 10px 24px rgba(239,68,68,.35)}

    .totals{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{ background:rgba(255,255,255,.6);border:1px solid rgba(0,0,0,.05); border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:600 }
    .dark .pill{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.08)}

    .list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .item{ background:rgba(255,255,255,.75);border:1px solid rgba(0,0,0,.06); border-radius:16px;padding:12px 14px;position:relative;overflow:hidden; box-shadow:0 10px 24px rgba(0,0,0,.09); touch-action: pan-y; }
    .dark .item{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.08)}
    .item h4{margin:0 0 6px 0;font-size:15px}
    .meta{color:var(--muted);font-size:12px;display:flex;flex-wrap:wrap;gap:10px}
    .sum{margin-top:6px;font-weight:700}
    .swipeDel{ position:absolute;inset:0;display:flex;align-items:center;justify-content:flex-end; padding-right:14px;pointer-events:none;opacity:.0;transition:opacity .15s; background:linear-gradient(90deg,transparent, rgba(239,68,68,.06)); }
    .swipeDel .btnDel{pointer-events:auto}
    .btnDel{border:0;background:var(--danger);color:#fff;border-radius:12px;padding:8px 12px;font-weight:700}

    .footerNote{color:var(--muted);font-size:12px;margin-top:8px}
    .chip{padding:2px 8px;border-radius:999px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.65)}
    .dark .chip{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.08)}

    .brk{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;margin-top:6px}
    .brk>div{background:rgba(255,255,255,.6);border:1px solid rgba(0,0,0,.05);border-radius:12px;padding:8px 10px;display:flex;justify-content:space-between;font-weight:600}
    .dark .brk>div{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.08)}
    .brk .sumrow{grid-column:1/-1}
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>æœˆè¨˜å¸³ï½œè–ªè³‡æ‰£é™¤è©¦ç®— & è¨˜éŒ„</h1>
      <span class="badge">114(2025) ç´šè·è‡ªå‹•å¸¶å…¥ãƒ»åªå¡«è–ªè³‡</span>
      <div style="margin-left:auto">
        <button id="toggleDark" class="round-btn" title="æš—è‰²æ¨¡å¼">ğŸŒ™ æš—è‰²</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- ç°¡æ˜“æ¨¡å¼ï¼šåªå¡«è–ªè³‡å³å¯ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="field">
            <label>æœ¬æœˆè–ªè³‡ï¼ˆå«åŠ ç­æ´¥è²¼ï¼‰</label>
            <input id="salary" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 42000" />
          </div>
          <div class="footerNote">å·²è‡ªå‹•åŒ…å«ï¼šå‹é€€è‡ªæ <b>6%</b>ã€ç¦åˆ©é‡‘ <b>0.5%</b>ï¼Œå‹/å¥ä¿ä¾ <b>114ç´šè·</b> ä»¥<b>å‘ä¸Šå–æ•´</b>å¸¶å…¥å“¡å·¥è² æ“”é‡‘é¡ï¼ˆå¯æ–¼ä¸‹æ–¹é€²éšè¨­å®šè¦†å¯«ï¼‰ã€‚</div>
          <div class="hr" style="height:8px"></div>
          <div class="totals">
            <div class="pill">æ‰£é™¤åˆè¨ˆ <span id="deductTotal">0</span></div>
            <div class="pill">å¯¦é ˜ <span id="netPay">0</span></div>
          </div>
          <div class="field" style="margin-top:8px">
            <label>è‡ªå‹•æ‰£é™¤æ˜ç´°ï¼ˆç´šè· <span id="vGrade">â€”</span>ï¼‰</label>
            <div class="brk">
              <div>å‹ä¿ <span id="vLB">0</span></div>
              <div>å¥ä¿ <span id="vNH">0</span></div>
              <div>å‹é€€è‡ªæ6% <span id="vP">0</span></div>
              <div>ç¦åˆ©é‡‘0.5% <span id="vWF">0</span></div>
              <div class="sumrow">åˆè¨ˆ <span id="vTotal">0</span></div>
            </div>
          </div>

          <div class="btns">
            <button id="btnAdd" class="round-btn">â• æ–°å¢ï¼æ›´æ–°æœ¬æœˆç´€éŒ„</button>
            <button id="btnExport" class="round-btn">â¬‡ï¸ åŒ¯å‡º JSON</button>
            <label class="round-btn" for="fileImport" style="cursor:pointer">â¬†ï¸ åŒ¯å…¥ JSON<input id="fileImport" type="file" accept="application/json" style="display:none"></label>
            <button id="btnClearAll" class="round-btn danger">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨ç´€éŒ„</button>
          </div>
        </div>
        <div>
          <canvas id="pie" height="260" style="margin-top:8px"></canvas>
        </div>
      </div>
    </section>

    <!-- æ”¯å‡º -->
    <section class="card">
      <div class="row">
        <div>
          <div class="field"><label>æ”¯å‡ºæœˆä»½</label><input id="expMonth" type="month" /></div>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div class="field"><label>æ—¥æœŸ</label><input id="expDate" type="date" /></div>
            <div class="field"><label>é‡‘é¡ï¼ˆå…ƒï¼‰</label><input id="expAmt" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 120" /></div>
          </div>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div class="field"><label>åˆ†é¡</label>
              <select id="expCat">
                <option value="é¤é£²">é¤é£²</option><option value="äº¤é€š">äº¤é€š</option><option value="æˆ¿ç§Ÿ/æˆ¿è²¸">æˆ¿ç§Ÿ/æˆ¿è²¸</option>
                <option value="æ°´é›»ç“¦æ–¯">æ°´é›»ç“¦æ–¯</option><option value="æ‰‹æ©Ÿç¶²è·¯">æ‰‹æ©Ÿç¶²è·¯</option><option value="é†«ç™‚/ä¿éšª">é†«ç™‚/ä¿éšª</option>
                <option value="è³¼ç‰©/å¨›æ¨‚">è³¼ç‰©/å¨›æ¨‚</option><option value="ç¨…è²»/æ‰‹çºŒè²»">ç¨…è²»/æ‰‹çºŒè²»</option><option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="field"><label>å‚™è¨»</label><input id="expMemo" type="text" placeholder="å¯ç•™ç©º" /></div>
          </div>
          <div class="btns">
            <button id="btnAddExp" class="round-btn">â• æ–°å¢æ”¯å‡º</button>
            <button id="btnClrExpMonth" class="round-btn danger">ğŸ—‘ï¸ åˆªé™¤æœ¬æœˆå…¨éƒ¨æ”¯å‡º</button>
            <button id="btnExportExp" class="round-btn">â¬‡ï¸ åŒ¯å‡ºæœ¬æœˆæ”¯å‡º</button>
            <label class="round-btn" for="fileImportExp" style="cursor:pointer">â¬†ï¸ åŒ¯å…¥æ”¯å‡º<input id="fileImportExp" type="file" accept="application/json" style="display:none"></label>
          </div>
        </div>
        <div>
          <div class="field">
            <label>æœ¬æœˆæ‘˜è¦</label>
            <div class="totals">
              <div class="pill">æœ¬æœˆæ”¯å‡ºåˆè¨ˆ <span id="expSum">0</span></div>
              <div class="pill">æœ¬æœˆå¯ç”¨é¤˜é¡ <span id="expRemain">0</span></div>
            </div>
            <div class="footerNote" id="expHint">â€”</div>
            <canvas id="pieExp" height="220" style="margin-top:8px"></canvas>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">æœ¬æœˆæ”¯å‡ºæ¸…å–®</h3>
        <span class="chip">å·¦å³æ»‘å‹•å¯åˆªé™¤ï¼Œé»æ“Šå¯è¼‰å…¥ç·¨è¼¯</span>
      </div>
      <div id="listExp" class="list"></div>
    </section>

    <!-- é€²éšè¨­å®šï¼šä¿ç•™ä½†é è¨­ä¸ç”¨å‹• -->
    <section class="card">
      <details id="advDetails">
        <summary style="cursor:pointer;font-weight:700">é€²éšè¨­å®šï¼ˆå¯æ‰‹å‹•è¦†å¯«é‡‘é¡ï¼æ¯”ç‡ï¼‰</summary>
        <div class="row" style="margin-top:12px">
          <div>
            <div class="field"><label>æœˆä»½</label><input id="month" type="month" /></div>
            <div class="field">
              <label class="flex"><span>ä¾ 114(2025) ç´šè·è‡ªå‹•å¸¶å…¥ï¼ˆå“¡å·¥è² æ“”ï¼šå‹ä¿ï¼‹å¥ä¿ï¼‰</span> <span class="chip">å‘ä¸Šå–æ•´</span></label>
              <div class="flex">
                <label style="display:inline-flex;align-items:center;gap:8px"><input id="chkAutoGrade" type="checkbox" checked> é–‹å•Ÿ</label>
                <select id="gradeSelect" style="width:180px"></select>
                <span id="gradeInfo" class="chip">â€”</span>
              </div>
            </div>
            <div class="field">
              <label class="flex"><span>å‹é€€è‡ªæï¼ˆé è¨­ 6%ï¼‰</span> <span class="chip">ä¾ç…§ <b>è–ªè³‡ Ã— %</b> è©¦ç®—</span></label>
              <div class="flex">
                <label style="display:inline-flex;align-items:center;gap:8px"><input id="chkPension" type="checkbox" checked> é–‹å•Ÿ</label>
                <input id="pensionRate" type="number" value="6" min="0" step="0.1" style="width:120px"/> <span>%</span>
                <span id="pensionAmtView" class="chip">é‡‘é¡ï¼š0</span>
              </div>
            </div>
            <div class="field">
              <label class="flex"><span>å‹ä¿ï¼ˆç´šè·æˆ–é‡‘é¡ï¼‰</span> <span class="chip">å¯æ“‡ä¸€ï¼š<b>é‡‘é¡ç›´å¡«</b> æˆ– <b>ç´šè· Ã— å“¡å·¥è² æ“”ç‡%</b></span></label>
              <div class="flex">
                <input id="lbAmount" type="number" placeholder="ç›´æ¥è¼¸å…¥é‡‘é¡ï¼ˆå…ƒï¼‰" style="width:220px" />
                <span>æˆ–</span>
                <input id="lbInsured" list="insuredList" type="number" placeholder="æŠ•ä¿è–ªè³‡ï¼ˆç´šè·ï¼‰" style="width:180px" />
                <input id="lbRate" type="number" placeholder="å“¡å·¥è² æ“”ç‡ %" style="width:150px" step="0.01" />
                <span id="lbAmtView" class="chip">é‡‘é¡ï¼š0</span>
              </div>
            </div>
            <div class="field">
              <label class="flex"><span>å¥ä¿ï¼ˆç´šè·æˆ–é‡‘é¡ï¼‰</span> <span class="chip">å¯æ“‡ä¸€ï¼š<b>é‡‘é¡ç›´å¡«</b> æˆ– <b>ç´šè· Ã— è¢«ä¿éšªäººè‡ªä»˜ç‡%</b></span></label>
              <div class="flex">
                <input id="nhAmount" type="number" placeholder="ç›´æ¥è¼¸å…¥é‡‘é¡ï¼ˆå…ƒï¼‰" style="width:220px" />
                <span>æˆ–</span>
                <input id="nhInsured" list="insuredList" type="number" placeholder="æŠ•ä¿è–ªè³‡ï¼ˆç´šè·ï¼‰" style="width:180px" />
                <input id="nhRate" type="number" placeholder="è¢«ä¿éšªäººè‡ªä»˜ç‡ %" style="width:150px" step="0.01" />
                <span id="nhAmtView" class="chip">é‡‘é¡ï¼š0</span>
              </div>
            </div>
            <datalist id="insuredList">
              <option value="28590"></option><option value="28800"></option><option value="30300"></option><option value="31800"></option>
              <option value="33300"></option><option value="34800"></option><option value="36300"></option><option value="38200"></option>
              <option value="40100"></option><option value="42000"></option><option value="43900"></option><option value="45800"></option>
              <option value="48200"></option><option value="50600"></option><option value="53000"></option><option value="55400"></option>
              <option value="57800"></option><option value="60800"></option><option value="63800"></option><option value="66800"></option>
              <option value="69800"></option><option value="72800"></option><option value="76500"></option>
            </datalist>
            <div class="field">
              <label class="flex"><span>ç¦åˆ©é‡‘ï¼ˆé è¨­ 0.5%ï¼‰</span> <span class="chip">ä¾ç…§ <b>è–ªè³‡ Ã— %</b> è©¦ç®—ï¼ˆå…¬å¸è¦å®šï¼‰</span></label>
              <div class="flex">
                <label style="display:inline-flex;align-items:center;gap:8px"><input id="chkWelfare" type="checkbox" checked> é–‹å•Ÿ</label>
                <input id="welfareRate" type="number" value="0.5" min="0" step="0.1" style="width:120px"/> <span>%</span>
                <span id="welfareAmtView" class="chip">é‡‘é¡ï¼š0</span>
              </div>
            </div>
          </div>
          <div>
            <div class="field">
              <label>åæ¨è–ªè³‡ï¼ˆå·²çŸ¥ã€Œæ‰£æ¬¾é‡‘é¡ã€èˆ‡ã€Œ%ã€ï¼‰</label>
              <div class="flex">
                <input id="revAmt" type="number" placeholder="ä¾‹å¦‚ï¼š2178" style="width:160px">
                <input id="revPct" type="number" placeholder="ä¾‹å¦‚ï¼š6" style="width:120px"> <span>%</span>
                <button id="btnReverse" class="round-btn">â†©ï¸ åæ¨</button>
              </div>
              <div class="pill" style="margin-top:8px">æ¨ç®—è–ªè³‡ <span id="revBase">0</span></div>
            </div>
          </div>
        </div>
      </details>
    </section>
  </main>

  <script>
    // ===== Dark mode =====
    var darkBtn = document.getElementById('toggleDark');
    var LS_DARK = 'paybook:dark';
    function applyDark(d){ document.documentElement.classList.toggle('dark', d); }
    applyDark(localStorage.getItem(LS_DARK)==='1');
    darkBtn.onclick = function(){ var d = !document.documentElement.classList.contains('dark'); localStorage.setItem(LS_DARK, d?'1':'0'); applyDark(d); }

    // ===== DOM refs =====
    function $(s){ return document.querySelector(s); }
    var month = $('#month');
    var salary = $('#salary');

    var chkAutoGrade = $('#chkAutoGrade');
    var gradeSelect = $('#gradeSelect');
    var gradeInfo = $('#gradeInfo');

    var chkPension = $('#chkPension');
    var pensionRate = $('#pensionRate');
    var pensionAmtView = $('#pensionAmtView');

    var lbAmount = $('#lbAmount');
    var lbInsured = $('#lbInsured');
    var lbRate = $('#lbRate');
    var lbAmtView = $('#lbAmtView');

    var nhAmount = $('#nhAmount');
    var nhInsured = $('#nhInsured');
    var nhRate = $('#nhRate');
    var nhAmtView = $('#nhAmtView');

    var chkWelfare = $('#chkWelfare');
    var welfareRate = $('#welfareRate');
    var welfareAmtView = $('#welfareAmtView');

    var deductTotal = $('#deductTotal');
    var netPay = $('#netPay');

    var vLB = $('#vLB');
    var vNH = $('#vNH');
    var vP = $('#vP');
    var vWF = $('#vWF');
    var vTotal = $('#vTotal');
    var vGrade = $('#vGrade');

    var btnAdd = $('#btnAdd');
    var btnExport = $('#btnExport');
    var fileImport = $('#fileImport');
    var btnClearAll = $('#btnClearAll');

    var list = $('#list');

    var revAmt = $('#revAmt');
    var revPct = $('#revPct');
    var btnReverse = $('#btnReverse');
    var revBase = $('#revBase');

    var LS_KEY = 'paybook:records';
    var LS_EXP = 'paybook:expenses';

    // ===== Utils =====
    function fmt(n){ return Number(n||0).toLocaleString('zh-TW', {maximumFractionDigits:0}); }
    function toNum(v){ if(v===undefined||v===null||v==='') return 0; var n=Number(v); return isFinite(n)?n:0; }
    function clamp(n,min){ if(min===void 0) min=0; return isFinite(n)? Math.max(n,min):0; }
    function gv(el){ return el && typeof el.value!=='undefined' ? el.value : ''; }
    function gi(el){ return toNum(gv(el)); }
    function st(el, s){ if(el) el.textContent = s; }

    // ===== 114(2025) ç´šè·è¡¨ï¼ˆå“¡å·¥è² æ“”ï¼šå‹ä¿/å¥ä¿/åˆè¨ˆï¼‰ =====
    var GRADES = [
      {g:28590, lb:715,  nh:443,  t:1158},
      {g:28800, lb:720,  nh:447,  t:1167},
      {g:30300, lb:758,  nh:470,  t:1228},
      {g:31800, lb:795,  nh:493,  t:1288},
      {g:33300, lb:833,  nh:516,  t:1349},
      {g:34800, lb:870,  nh:540,  t:1410},
      {g:36300, lb:908,  nh:563,  t:1471},
      {g:38200, lb:955,  nh:592,  t:1547},
      {g:40100, lb:1002, nh:622,  t:1624},
      {g:42000, lb:1050, nh:651,  t:1701},
      {g:43900, lb:1098, nh:681,  t:1779},
      {g:45800, lb:1145, nh:710,  t:1855},
      {g:48200, lb:1145, nh:748,  t:1893},
      {g:50600, lb:1145, nh:785,  t:1930},
      {g:53000, lb:1145, nh:822,  t:1967},
      {g:55400, lb:1145, nh:859,  t:2004},
      {g:57800, lb:1145, nh:896,  t:2041},
      {g:60800, lb:1145, nh:943,  t:2088},
      {g:63800, lb:1145, nh:990,  t:2135},
      {g:66800, lb:1145, nh:1036, t:2181},
      {g:69800, lb:1145, nh:1083, t:2228},
      {g:72800, lb:1145, nh:1129, t:2274},
      {g:76500, lb:1145, nh:1187, t:2332}
    ];

    function buildGradeOptions(){
      if(!gradeSelect) return;
      gradeSelect.innerHTML = '';
      for(var i=0;i<GRADES.length;i++){
        var r = GRADES[i];
        var opt = document.createElement('option');
        opt.value = r.g;
        opt.textContent = r.g.toLocaleString()+`ï¼ˆå‹ä¿ ${r.lb.toLocaleString()}ï¼å¥ä¿ ${r.nh.toLocaleString()}ï¼åˆè¨ˆ ${r.t.toLocaleString()}ï¼‰`;
        gradeSelect.appendChild(opt);
      }
    }

    // å‘ä¸Šå–æ•´ï¼šé¸æ“‡ç¬¬ä¸€å€‹ >= è–ªè³‡ çš„ç´šè·ï¼›è¶…å‡ºè¡¨æ ¼ä¸Šé™å‰‡ä½¿ç”¨æœ€é«˜ç´šè·
    function pickGradeBySalary(base){
      for(var i=0;i<GRADES.length;i++){ var r = GRADES[i]; if(base <= r.g) return r; }
      return GRADES[GRADES.length-1];
    }

    var lastGradeRow = null; var manualGrade = false;

    // ===== Chart =====
    var pie; var ctx = document.getElementById('pie');
    var pieExp; var ctxExp = document.getElementById('pieExp');
    function upChart(parts){
      try{
        var labels = (parts||[]).filter(function(p){return p.v>0}).map(function(p){return p.k});
        var data = (parts||[]).filter(function(p){return p.v>0}).map(function(p){return p.v});
        if(typeof Chart==='undefined' || !ctx){ return; }
        if(!pie){
          if(labels.length===0) return; // æ²’è³‡æ–™å°±ä¸å»ºç«‹åœ–
          pie = new Chart(ctx,{ type:'doughnut', data:{labels:labels,datasets:[{data:data}]}, options:{plugins:{legend:{position:'bottom'}},cutout:'60%'} });
        } else {
          pie.data.labels = labels; pie.data.datasets[0].data = data; pie.update();
        }
      }catch(e){}
    }).map(function(p){return p.k}); var data = parts.filter(function(p){return p.v>0}).map(function(p){return p.v}); if(typeof Chart==='undefined' || !ctx){ return; } if(!pie){ pie = new Chart(ctx,{ type:'doughnut', data:{labels:labels,datasets:[{data:data}]}, options:{plugins:{legend:{position:'bottom'}},cutout:'60%'} }); } else { pie.data.labels = labels; pie.data.datasets[0].data = data; pie.update(); } }catch(e){} }
    function upExpChart(group){ try{ if(typeof Chart==='undefined' || !ctxExp){ return; } var labels = Object.keys(group); var data = labels.map(function(k){return group[k]}); if(!pieExp){ pieExp = new Chart(ctxExp,{ type:'doughnut', data:{labels:labels,datasets:[{data:data}]}, options:{plugins:{legend:{position:'bottom'}},cutout:'60%'} }); } else { pieExp.data.labels = labels; pieExp.data.datasets[0].data = data; pieExp.update(); } }catch(e){} }

    // ===== Live calc =====
    function calc(){
      if(!salary) return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 };
      var base = clamp(toNum(salary.value));
      // è‹¥å°šæœªè¼¸å…¥è–ªè³‡ï¼Œå…¨éƒ¨æ­¸é›¶ï¼Œä¸è‡ªå‹•æŒ‘ç´šè·
      if(!(base>0)){
        st(pensionAmtView,'é‡‘é¡ï¼š0'); st(welfareAmtView,'é‡‘é¡ï¼š0');
        st(lbAmtView,'é‡‘é¡ï¼š0'); st(nhAmtView,'é‡‘é¡ï¼š0');
        st(deductTotal,'0'); st(netPay,'0');
        st(vLB,'0'); st(vNH,'0'); st(vP,'0'); st(vWF,'0'); st(vTotal,'0'); st(vGrade,'â€”');
        if(gradeInfo) gradeInfo.textContent = 'â€”';
        upChart([]);
        return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 };
      }

      // é¸ç´šè·ï¼ˆå‘ä¸Šå–æ•´ï¼‰ï¼Œè‹¥æ‰‹å‹•ä¸”ä¸ä½æ–¼è–ªè³‡å‰‡æ²¿ç”¨
      var row = pickGradeBySalary(base);
      if(gradeSelect && manualGrade){
        var sel = toNum(gradeSelect.value);
        if(sel >= base){ for(var i=0;i<GRADES.length;i++){ if(GRADES[i].g===sel){ row = GRADES[i]; break; } } }
      } else if(gradeSelect){ gradeSelect.value = String(row.g); }
      lastGradeRow = row;
      if(gradeInfo){ var over = base > GRADES[GRADES.length-1].g; gradeInfo.textContent = 'ç´šè· '+row.g.toLocaleString()+'ï¼Œå“¡å·¥åˆè¨ˆ '+row.t.toLocaleString()+' å…ƒ' + (over? 'ï¼ˆè¶…å‡ºè¡¨ä¸Šé™ï¼Œå·²ç”¨æœ€é«˜ç´šè·ï¼‰':''); }

      // å‹é€€ / ç¦åˆ©
      var pr = gi(pensionRate); if(!(pr>0)) pr = 6; var pAmt = Math.round(base * clamp(pr)/100); st(pensionAmtView, 'é‡‘é¡ï¼š'+fmt(pAmt));
      var wr = gi(welfareRate); if(!(wr>0)) wr = 0.5; var wfAmt = Math.round(base * clamp(wr)/100); st(welfareAmtView, 'é‡‘é¡ï¼š'+fmt(wfAmt));

      // å‹ä¿/å¥ä¿ï¼šå„ªå…ˆæ‰‹å‹•é‡‘é¡ï¼Œå¦å‰‡ç”¨ç´šè·ï¼›å†å¦å‰‡ç”¨ï¼ˆç´šè·Ã—%ï¼‰
      var lbAmt = gi(lbAmount); var nhAmt = gi(nhAmount);
      if(!(lbAmt>0)) lbAmt = row.lb;
      if(!(nhAmt>0)) nhAmt = row.nh;
      if(!(lbAmt>0)){ var ins1 = gi(lbInsured); var r1 = gi(lbRate); if(ins1>0 && r1>0) lbAmt = Math.round(ins1*r1/100); }
      if(!(nhAmt>0)){ var ins2 = gi(nhInsured); var r2 = gi(nhRate); if(ins2>0 && r2>0) nhAmt = Math.round(ins2*r2/100); }
      st(lbAmtView, 'é‡‘é¡ï¼š'+fmt(lbAmt)); st(nhAmtView, 'é‡‘é¡ï¼š'+fmt(nhAmt));

      var totalDeduct = pAmt + lbAmt + nhAmt + wfAmt;
      var net = Math.max(0, base - totalDeduct);
      st(deductTotal, fmt(totalDeduct)); st(netPay, fmt(net));

      st(vLB, fmt(lbAmt)); st(vNH, fmt(nhAmt)); st(vP, fmt(pAmt)); st(vWF, fmt(wfAmt)); st(vTotal, fmt(totalDeduct)); st(vGrade, lastGradeRow? lastGradeRow.g.toLocaleString() : 'â€”');

      upChart([{k:'è‡ªæ6%', v:pAmt}, {k:'å‹ä¿', v:lbAmt}, {k:'å¥ä¿', v:nhAmt}, {k:'ç¦åˆ©é‡‘', v:wfAmt}]);
      return { base:base, pAmt:pAmt, lbAmt:lbAmt, nhAmt:nhAmt, wfAmt:wfAmt, totalDeduct:totalDeduct, net:net };
    }

    function calcSafe(){ try{ return calc(); } catch(e){ console.error('calc error', e); return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 }; } }

    // äº‹ä»¶
    ;['input','change','keyup'].forEach(function(evt){
      [salary, gradeSelect, pensionRate, lbAmount, lbInsured, lbRate, nhAmount, nhInsured, nhRate, welfareRate]
        .filter(function(el){return !!el})
        .forEach(function(el){ el.addEventListener(evt, calcSafe); });
    });
    if(salary){ salary.addEventListener('input', function(){ manualGrade = false; }); }
    if(gradeSelect){ gradeSelect.addEventListener('change', function(){ var base = clamp(toNum(salary.value)); var sel = toNum(gradeSelect.value); if(sel < base){ var r = pickGradeBySalary(base); gradeSelect.value = String(r.g); alert('æŠ•ä¿è–ªè³‡ä¸å¾—ä½æ–¼å¯¦éš›è–ªè³‡ï¼Œå·²æ”¹ç‚º '+r.g.toLocaleString()+' ç´šè·'); } manualGrade = true; calcSafe(); }); }

    // ===== Recordsï¼ˆè–ªè³‡æœˆç´€éŒ„ï¼‰ =====
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return [] } }
    function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function render(){ var arr = load().sort(function(a,b){ return (a.month||'').localeCompare(b.month||''); }); var listEl = document.getElementById('list'); if(!listEl) return; listEl.innerHTML = ''; if(arr.length===0){ listEl.innerHTML = '<div class="footerNote">å°šç„¡ç´€éŒ„ï¼Œå¡«å¯«è–ªè³‡å¾ŒæŒ‰ã€Œæ–°å¢ï¼æ›´æ–°æœ¬æœˆç´€éŒ„ã€ã€‚</div>'; return; } for(var i=0;i<arr.length;i++){ var rec = arr[i]; var div = document.createElement('div'); div.className = 'item'; div.innerHTML = '<div class="swipeDel"><button class="btnDel">åˆªé™¤</button></div>'+
      '<h4>'+rec.month+'ï½œå¯¦é ˜ '+fmt(rec.net)+' å…ƒ</h4>'+
      '<div class="meta"><span>è–ªè³‡ '+fmt(rec.base)+'</span><span>å‹é€€è‡ªæ '+fmt(rec.pAmt)+'</span><span>å‹ä¿ '+fmt(rec.lbAmt)+'</span><span>å¥ä¿ '+fmt(rec.nhAmt)+'</span><span>ç¦åˆ©é‡‘ '+fmt(rec.wfAmt)+'</span></div>'+
      '<div class="sum">æ‰£é™¤åˆè¨ˆï¼š'+fmt(rec.totalDeduct)+' å…ƒ</div>';
      (function(div,rec){ var sx=0,dx=0; var del = div.querySelector('.swipeDel'); var btnDel = div.querySelector('.btnDel'); btnDel.addEventListener('click', function(){ if(!confirm('åˆªé™¤ '+rec.month+' ç´€éŒ„ï¼Ÿ')) return; var all = load().filter(function(x){return x.month!==rec.month}); save(all); render(); }); div.addEventListener('touchstart', function(e){ sx = e.changedTouches[0].clientX; }); div.addEventListener('touchmove', function(e){ dx = e.changedTouches[0].clientX - sx; del.style.opacity = Math.min(1, Math.max(0, (-dx)/80)); }); div.addEventListener('touchend', function(){ del.style.opacity = dx < -80 ? 1 : 0; sx=dx=0; }); div.addEventListener('click', function(e){ if(e.target.classList.contains('btnDel')) return; if(month) month.value = rec.month; salary.value = rec.base; calcSafe(); window.scrollTo({top:0, behavior:'smooth'}); }); })(div,rec); listEl.appendChild(div);} }

    function addOrUpdate(){ var m = (month && month.value) || new Date().toISOString().slice(0,7); var c = calcSafe(); var rec = { month:m, base:c.base, pRate:6, pAmt:c.pAmt, lbAmt:c.lbAmt, nhAmt:c.nhAmt, wfRate:0.5, wfAmt:c.wfAmt, totalDeduct:c.totalDeduct, net:c.net }; var arr = load(); var i = arr.findIndex? arr.findIndex(function(x){return x.month===m}) : (function(){ for(var j=0;j<arr.length;j++){ if(arr[j].month===m) return j; } return -1; })(); if(i>=0) arr[i]=rec; else arr.push(rec); save(arr); render(); }

    if(btnAdd) btnAdd.addEventListener('click', addOrUpdate);
    if(btnExport) btnExport.addEventListener('click', function(){ var data = JSON.stringify(load(), null, 2); var blob = new Blob([data], {type:'application/json'}); var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'paybook-records.json'; a.click(); URL.revokeObjectURL(a.href); });
    if(fileImport) fileImport.addEventListener('change', function(e){ var f = e.target.files && e.target.files[0]; if(!f) return; var rd = new FileReader(); rd.onload = function(){ try{ var arr = JSON.parse(rd.result); if(arr && arr.constructor===Array){ save(arr); render(); alert('åŒ¯å…¥å®Œæˆ'); } }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; rd.readAsText(f); });
    if(btnClearAll) btnClearAll.addEventListener('click', function(){ if(confirm('ç¢ºå®šè¦æ¸…ç©ºå…¨éƒ¨ç´€éŒ„ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')){ save([]); render(); } });

    // ===== Expenses (æ¯æœˆæ”¯å‡º) =====
    var expMonth = $('#expMonth'); var expDate = $('#expDate'); var expAmt = $('#expAmt'); var expCat = $('#expCat'); var expMemo = $('#expMemo'); var listExp = $('#listExp'); var expSum = $('#expSum'); var expRemain = $('#expRemain'); var expHint = $('#expHint'); var btnAddExp = $('#btnAddExp'); var btnClrExpMonth = $('#btnClrExpMonth'); var btnExportExp = $('#btnExportExp'); var fileImportExp = $('#fileImportExp');

    function loadExp(){ try{ return JSON.parse(localStorage.getItem(LS_EXP)||'[]'); }catch(e){ return [] } }
    function saveExp(arr){ localStorage.setItem(LS_EXP, JSON.stringify(arr)); }
    function monthOf(d){ return (d||new Date().toISOString().slice(0,10)).slice(0,7); }

    function renderExp(){ var m = expMonth && expMonth.value ? expMonth.value : new Date().toISOString().slice(0,7); if(expMonth && !expMonth.value) expMonth.value = m; var arr = loadExp().filter(function(x){return x.month===m}); listExp.innerHTML = ''; var total = 0; var group = {}; for(var i=0;i<arr.length;i++){ var it = arr[i]; total += Number(it.amt)||0; group[it.cat] = (group[it.cat]||0) + (Number(it.amt)||0); var div = document.createElement('div'); div.className = 'item'; div.innerHTML = '<div class="swipeDel"><button class="btnDel">åˆªé™¤</button></div>'+'<h4>'+it.date+'ï½œ'+it.cat+' '+fmt(it.amt)+' å…ƒ</h4>'+'<div class="meta">'+(it.memo||'â€”')+'</div>'; (function(div,it){ var btnDel = div.querySelector('.btnDel'); btnDel.addEventListener('click', function(){ var all = loadExp().filter(function(x){return x.id!==it.id}); saveExp(all); renderExp(); }); var sx=0, dx=0; var del = div.querySelector('.swipeDel'); div.addEventListener('touchstart', function(e){ sx = e.changedTouches[0].clientX; }); div.addEventListener('touchmove', function(e){ dx = e.changedTouches[0].clientX - sx; del.style.opacity = Math.min(1, Math.max(0, (-dx)/80)); }); div.addEventListener('touchend', function(){ del.style.opacity = dx < -80 ? 1 : 0; sx=dx=0; }); div.addEventListener('click', function(e){ if(e.target.classList.contains('btnDel')) return; expDate.value = it.date; expAmt.value = it.amt; expCat.value = it.cat; expMemo.value = it.memo||''; }); })(div,it); listExp.appendChild(div); }
      expSum.textContent = fmt(total); var payRec = load().find? load().find(function(r){return r.month===m}) : null; var monthlyNet = payRec? payRec.net : calcSafe().net; expRemain.textContent = fmt(Math.max(0, (monthlyNet||0) - total)); expHint.textContent = payRec? ('ä»¥ '+m+' çš„è–ªè³‡å¯¦é ˜ '+fmt(monthlyNet)+' å…ƒè¨ˆç®—ã€‚') : 'å°šæœªå»ºç«‹è©²æœˆè–ªè³‡ç´€éŒ„ï¼Œæš«ä»¥ç›®å‰è–ªè³‡è¼¸å…¥è©¦ç®—å¯ç”¨é¤˜é¡ã€‚'; upExpChart(group); }

    function addExp(){ var d = expDate && expDate.value ? expDate.value : new Date().toISOString().slice(0,10); var m = monthOf(d); if(expMonth) expMonth.value = m; var amt = Number(expAmt && expAmt.value ? expAmt.value : 0); if(!(amt>0)) { alert('è«‹è¼¸å…¥é‡‘é¡'); return; } var rec = { id: Date.now()+''+Math.random().toString(16).slice(2), date:d, month:m, cat:(expCat && expCat.value ? expCat.value : 'å…¶ä»–'), amt:amt, memo:(expMemo && expMemo.value ? expMemo.value : '') }; var arr = loadExp(); arr.push(rec); saveExp(arr); renderExp(); expAmt.value = ''; expMemo.value=''; }

    if(btnAddExp) btnAddExp.addEventListener('click', addExp);
    if(btnClrExpMonth) btnClrExpMonth.addEventListener('click', function(){ var m = expMonth && expMonth.value ? expMonth.value : monthOf(); if(!confirm('åˆªé™¤ '+m+' çš„å…¨éƒ¨æ”¯å‡ºï¼Ÿ')) return; var arr = loadExp().filter(function(x){return x.month!==m}); saveExp(arr); renderExp(); });
    if(btnExportExp) btnExportExp.addEventListener('click', function(){ var m = expMonth && expMonth.value ? expMonth.value : monthOf(); var data = JSON.stringify(loadExp().filter(function(x){return x.month===m}), null, 2); var blob = new Blob([data], {type:'application/json'}); var a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'expenses-'+m+'.json'; a.click(); URL.revokeObjectURL(a.href); });
    if(fileImportExp) fileImportExp.addEventListener('change', function(e){ var f = e.target.files && e.target.files[0]; if(!f) return; var rd = new FileReader(); rd.onload = function(){ try{ var arr = JSON.parse(rd.result); if(arr && arr.constructor===Array){ var all = loadExp().concat(arr); saveExp(all); renderExp(); alert('æ”¯å‡ºåŒ¯å…¥å®Œæˆ'); } } catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; rd.readAsText(f); });

    if(salary) salary.addEventListener('input', renderExp);
    if(expMonth) expMonth.addEventListener('change', renderExp);

    // ===== init =====
    if(month) month.value = new Date().toISOString().slice(0,7);
    if(expMonth) expMonth.value = new Date().toISOString().slice(0,7);
    if(expDate) expDate.value = new Date().toISOString().slice(0,10);
    buildGradeOptions();
    // åˆå§‹è§¸ç™¼è¨ˆç®—ï¼ˆå†å»¶é²ä¸€æ¬¡é¿å…æŸäº›ç€è¦½å™¨å»¶å¾Œç¹ªè£½ï¼‰
    calcSafe(); setTimeout(calcSafe, 0);
    render(); renderExp();
  </script>
</body>
</html>
