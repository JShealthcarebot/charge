<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æœˆè¨˜å¸³ï½œè–ªè³‡æ‰£é™¤è©¦ç®—ï¼†è¨˜éŒ„ï¼ˆç©©å®šç‰ˆï¼Œåƒ…å“¡å·¥ç«¯ï¼‰</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{ --bg:linear-gradient(135deg,#eaf6ff,#f6f9ff); --card:rgba(255,255,255,.85); --text:#1f2937; --muted:#6b7280; --brand:#4f46e5; --danger:#ef4444; --ring:rgba(79,70,229,.25);} 
    .dark{ --bg: radial-gradient(1200px 800px at 10% 10%, #1f2937, #0b1020); --card:rgba(17,24,39,.75); --text:#e5e7eb; --muted:#9ca3af; --brand:#8b5cf6; --danger:#f87171; --ring:rgba(139,92,246,.25); color-scheme:dark; }
    *{box-sizing:border-box}
    body{margin:0;min-height:100dvh;display:flex;flex-direction:column;gap:16px;font-family:"Noto Sans TC",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:transparent;padding:16px 12px 0;backdrop-filter:saturate(150%) blur(10px)}
    .wrap{max-width:980px;margin:0 auto;padding:12px}
    .title{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .title h1{margin:0;font-size:22px;font-weight:700}
    .badge{font-size:12px;padding:4px 10px;border-radius:999px;background:var(--card);border:1px solid rgba(0,0,0,.05)}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.35);border-radius:18px;box-shadow:0 12px 40px rgba(0,0,0,.12);backdrop-filter:blur(12px) saturate(160%);padding:16px;margin:8px 0}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:720px){.row{grid-template-columns:1.25fr .75fr}}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:var(--muted)}
    input,select{height:42px;padding:0 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);background:rgba(255,255,255,.7);outline:none;color:inherit}
    .dark input,.dark select{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.08)}
    input:focus,select:focus{box-shadow:0 0 0 6px var(--ring);border-color:transparent}
    .pill{background:rgba(255,255,255,.6);border:1px solid rgba(0,0,0,.06);border-radius:14px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;font-weight:600}
    .dark .pill{background:rgba(0,0,0,.3);border-color:rgba(255,255,255,.08)}
    .totals{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    .round-btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;height:46px;padding:0 18px;border-radius:999px;border:0;cursor:pointer;background:linear-gradient(135deg,var(--brand),#22c1c3);color:#fff;font-weight:600;box-shadow:0 10px 24px rgba(79,70,229,.35)}
    .danger{background:linear-gradient(135deg,var(--danger),#ef5da8)}
    .list{display:flex;flex-direction:column;gap:12px;margin-top:8px}
    .item{background:rgba(255,255,255,.78);border:1px solid rgba(0,0,0,.06);border-radius:16px;padding:12px 14px;position:relative;box-shadow:0 10px 24px rgba(0,0,0,.09)}
    .dark .item{background:rgba(0,0,0,.25);border-color:rgba(255,255,255,.08)}
    .item h4{margin:0 0 6px 0;font-size:15px}
    .meta{color:var(--muted);font-size:12px}
    .trash{position:absolute;right:10px;top:10px;border:0;background:var(--danger);color:#fff;border-radius:10px;padding:6px 10px;font-weight:700;cursor:pointer}
    .footerNote{color:var(--muted);font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <h1>æœˆè¨˜å¸³ï½œè–ªè³‡æ‰£é™¤è©¦ç®—ï¼†è¨˜éŒ„</h1>
      <span class="badge">114(2025) ç´šè·è‡ªå‹•å¸¶å…¥ï¼ˆå‘ä¸Šå–æ•´ï¼‰ãƒ»åƒ…å“¡å·¥ç«¯ãƒ»ç©©å®šç‰ˆ</span>
      <div style="margin-left:auto"><button id="toggleDark" class="round-btn" title="æš—è‰²/äº®è‰²">ğŸŒ™ æš—è‰²</button></div>
    </div>
  </header>

  <main class="wrap">
    <!-- ç°¡æ˜“æ¨¡å¼ï¼šåªå¡«è–ªè³‡å³å¯è‡ªå‹•å¸¶å…¥ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="field">
            <label>æœ¬æœˆè–ªè³‡ï¼ˆå«åŠ ç­æ´¥è²¼ï¼‰</label>
            <input id="salary" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 42000" />
          </div>
          <div class="footerNote">è‡ªå‹•åŒ…å«ï¼šå‹é€€è‡ªæ <b>6%</b>ã€ç¦åˆ©é‡‘ <b>0.5%</b>ï¼›å‹/å¥ä¿ä¾ <b>114 ç´šè·</b> ä»¥<b>å‘ä¸Šå–æ•´</b>å¸¶å…¥å“¡å·¥è² æ“”é‡‘é¡ã€‚</div>
          <div class="totals" style="margin-top:8px">
            <div class="pill">æ‰£é™¤åˆè¨ˆ <span id="deductTotal">0</span></div>
            <div class="pill">å¯¦é ˜ <span id="netPay">0</span></div>
          </div>
          <div class="field" style="margin-top:8px">
            <label>è‡ªå‹•æ‰£é™¤æ˜ç´°ï¼ˆç´šè· <span id="vGrade">â€”</span>ï¼‰</label>
            <div class="totals">
              <div class="pill">å‹ä¿ <span id="vLB">0</span></div>
              <div class="pill">å¥ä¿ <span id="vNH">0</span></div>
            </div>
            <div class="totals" style="margin-top:8px">
              <div class="pill">å‹é€€è‡ªæ6% <span id="vP">0</span></div>
              <div class="pill">ç¦åˆ©é‡‘0.5% <span id="vWF">0</span></div>
            </div>
            <div class="pill" style="margin-top:8px">åˆè¨ˆ <span id="vTotal">0</span></div>
          </div>

          <div class="btns">
            <button id="btnAdd" class="round-btn">â• æ–°å¢ï¼æ›´æ–°æœ¬æœˆç´€éŒ„</button>
            <button id="btnExport" class="round-btn">â¬‡ï¸ åŒ¯å‡º JSON</button>
            <label class="round-btn" for="fileImport" style="cursor:pointer">â¬†ï¸ åŒ¯å…¥ JSON<input id="fileImport" type="file" accept="application/json" style="display:none"></label>
            <button id="btnClearAll" class="round-btn danger">ğŸ—‘ï¸ æ¸…ç©ºå…¨éƒ¨ç´€éŒ„</button>
          </div>
        </div>
        <div>
          <canvas id="pie" height="260" style="margin-top:8px"></canvas>
        </div>
      </div>
    </section>

    <!-- æ”¯å‡ºè¨˜éŒ„ -->
    <section class="card">
      <div class="row">
        <div>
          <div class="field">
            <label>æ”¯å‡ºæœˆä»½</label>
            <input id="expMonth" type="month" />
          </div>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div class="field"><label>æ—¥æœŸ</label><input id="expDate" type="date" /></div>
            <div class="field"><label>é‡‘é¡ï¼ˆå…ƒï¼‰</label><input id="expAmt" type="number" inputmode="decimal" placeholder="ä¾‹å¦‚ 120" /></div>
          </div>
          <div class="row" style="grid-template-columns:1fr 1fr">
            <div class="field">
              <label>åˆ†é¡</label>
              <select id="expCat">
                <option value="é¤é£²">é¤é£²</option>
                <option value="äº¤é€š">äº¤é€š</option>
                <option value="æˆ¿ç§Ÿ/æˆ¿è²¸">æˆ¿ç§Ÿ/æˆ¿è²¸</option>
                <option value="æ°´é›»ç“¦æ–¯">æ°´é›»ç“¦æ–¯</option>
                <option value="æ‰‹æ©Ÿç¶²è·¯">æ‰‹æ©Ÿç¶²è·¯</option>
                <option value="é†«ç™‚/ä¿éšª">é†«ç™‚/ä¿éšª</option>
                <option value="è³¼ç‰©/å¨›æ¨‚">è³¼ç‰©/å¨›æ¨‚</option>
                <option value="ç¨…è²»/æ‰‹çºŒè²»">ç¨…è²»/æ‰‹çºŒè²»</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="field"><label>å‚™è¨»</label><input id="expMemo" type="text" placeholder="å¯ç•™ç©º" /></div>
          </div>
          <div class="btns">
            <button id="btnAddExp" class="round-btn">â• æ–°å¢æ”¯å‡º</button>
            <button id="btnClrExpMonth" class="round-btn danger">ğŸ—‘ï¸ åˆªé™¤æœ¬æœˆå…¨éƒ¨æ”¯å‡º</button>
            <button id="btnExportExp" class="round-btn">â¬‡ï¸ åŒ¯å‡ºæœ¬æœˆæ”¯å‡º</button>
            <label class="round-btn" for="fileImportExp" style="cursor:pointer">â¬†ï¸ åŒ¯å…¥æ”¯å‡º<input id="fileImportExp" type="file" accept="application/json" style="display:none"></label>
          </div>
        </div>
        <div>
          <div class="field">
            <label>æœ¬æœˆæ‘˜è¦</label>
            <div class="totals">
              <div class="pill">æœ¬æœˆæ”¯å‡ºåˆè¨ˆ <span id="expSum">0</span></div>
              <div class="pill">æœ¬æœˆå¯ç”¨é¤˜é¡ <span id="expRemain">0</span></div>
            </div>
            <div class="footerNote" id="expHint">â€”</div>
            <canvas id="pieExp" height="220" style="margin-top:8px"></canvas>
          </div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">æœ¬æœˆæ”¯å‡ºæ¸…å–®</h3>
        <span class="footerNote">å¯é»å³ä¸Šè§’åƒåœ¾æ¡¶åˆªé™¤ï¼›æˆ–æ‰‹æ©Ÿä¸Šå·¦å³æ»‘å‹•ã€‚</span>
      </div>
      <div id="listExp" class="list"></div>
    </section>

    <!-- è–ªè³‡ç´€éŒ„æ¸…å–® -->
    <section class="card">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">æˆ‘çš„æ¯æœˆè–ªè³‡ç´€éŒ„</h3>
      </div>
      <div id="list" class="list"></div>
    </section>
  </main>

  <script>
    // ===== æš—è‰²æ¨¡å¼ =====
    var darkBtn = document.getElementById('toggleDark');
    var LS_DARK = 'paybook:dark';
    function applyDark(d){ document.documentElement.classList.toggle('dark', d); }
    applyDark(localStorage.getItem(LS_DARK)==='1');
    darkBtn.onclick = function(){ var d = !document.documentElement.classList.contains('dark'); localStorage.setItem(LS_DARK, d?'1':'0'); applyDark(d); };

    // ===== DOM Refs =====
    function $(s){return document.querySelector(s)}
    var month = $('#month');
    var salary = $('#salary');
    var deductTotal = $('#deductTotal');
    var netPay = $('#netPay');
    var vLB=$('#vLB'), vNH=$('#vNH'), vP=$('#vP'), vWF=$('#vWF'), vTotal=$('#vTotal'), vGrade=$('#vGrade');
    var pensionRate = {value:6}, welfareRate = {value:0.5}; // ç©©å®šç‰ˆï¼šå›ºå®šæ¯”ç‡
    var pensionAmtView = {textContent:''}, welfareAmtView = {textContent:''}; // é¡¯ç¤ºåœ¨æ˜ç´°å³å¯
    var gradeInfo = null; // ä¸ä½¿ç”¨é¡å¤–æ¬„ä½

    var btnAdd = $('#btnAdd');
    var btnExport = $('#btnExport');
    var fileImport = $('#fileImport');
    var btnClearAll = $('#btnClearAll');
    var list = $('#list');

    // æ”¯å‡º DOM
    var expMonth=$('#expMonth'), expDate=$('#expDate'), expAmt=$('#expAmt'), expCat=$('#expCat'), expMemo=$('#expMemo');
    var listExp=$('#listExp'), expSum=$('#expSum'), expRemain=$('#expRemain'), expHint=$('#expHint');
    var btnAddExp=$('#btnAddExp'), btnClrExpMonth=$('#btnClrExpMonth'), btnExportExp=$('#btnExportExp'), fileImportExp=$('#fileImportExp');

    // ===== Utils =====
    function fmt(n){ return Number(n||0).toLocaleString('zh-TW',{maximumFractionDigits:0}) }
    function toNum(v){ return (v===''||v==null)?0:Number(v) }
    function clamp(n,min){ if(min===void 0) min=0; return isFinite(n)?Math.max(n,min):0 }
    function st(el,txt){ if(el){ el.textContent = String(txt); } }

    // ===== Chart å®‰å…¨æ›´æ–° =====
    var pie, ctx = document.getElementById('pie');
    var pieExp, ctxExp = document.getElementById('pieExp');
    function upChart(parts){
      try{
        var labels=(parts||[]).filter(function(p){return p.v>0}).map(function(p){return p.k});
        var data=(parts||[]).filter(function(p){return p.v>0}).map(function(p){return p.v});
        if(typeof Chart==='undefined' || !ctx){ return; }
        if(!pie){ if(labels.length===0) return; pie = new Chart(ctx,{type:'doughnut',data:{labels:labels,datasets:[{data:data}]},options:{plugins:{legend:{position:'bottom'}},cutout:'60%'}}); }
        else{ pie.data.labels=labels; pie.data.datasets[0].data=data; pie.update(); }
      }catch(e){}
    }
    function upExpChart(group){
      try{
        var labels=Object.keys(group||{}); var data=labels.map(function(k){return group[k]});
        if(typeof Chart==='undefined' || !ctxExp){ return; }
        if(!pieExp){ if(labels.length===0) return; pieExp = new Chart(ctxExp,{type:'doughnut',data:{labels:labels,datasets:[{data:data}]},options:{plugins:{legend:{position:'bottom'}},cutout:'60%'}}); }
        else{ pieExp.data.labels=labels; pieExp.data.datasets[0].data=data; pieExp.update(); }
      }catch(e){}
    }

    // ===== 114(2025) å“¡å·¥è² æ“”ç´šè·è¡¨ =====
    var GRADES = [
      {g:28590, lb:715,  nh:443,  t:1158},
      {g:28800, lb:720,  nh:447,  t:1167},
      {g:30300, lb:758,  nh:470,  t:1228},
      {g:31800, lb:795,  nh:493,  t:1288},
      {g:33300, lb:833,  nh:516,  t:1349},
      {g:34800, lb:870,  nh:540,  t:1410},
      {g:36300, lb:908,  nh:563,  t:1471},
      {g:38200, lb:955,  nh:592,  t:1547},
      {g:40100, lb:1002, nh:622,  t:1624},
      {g:42000, lb:1050, nh:651,  t:1701},
      {g:43900, lb:1098, nh:681,  t:1779},
      {g:45800, lb:1145, nh:710,  t:1855},
      {g:48200, lb:1145, nh:748,  t:1893},
      {g:50600, lb:1145, nh:785,  t:1930},
      {g:53000, lb:1145, nh:822,  t:1967},
      {g:55400, lb:1145, nh:859,  t:2004},
      {g:57800, lb:1145, nh:896,  t:2041},
      {g:60800, lb:1145, nh:943,  t:2088},
      {g:63800, lb:1145, nh:990,  t:2135},
      {g:66800, lb:1145, nh:1036, t:2181},
      {g:69800, lb:1145, nh:1083, t:2228},
      {g:72800, lb:1145, nh:1129, t:2274},
      {g:76500, lb:1145, nh:1187, t:2332}
    ];

    function pickGradeBySalaryUp(base){ for(var i=0;i<GRADES.length;i++){ if(base <= GRADES[i].g) return GRADES[i]; } return GRADES[GRADES.length-1]; }

    // ===== è¨ˆç®—ä¸»ç¨‹å¼ =====
    var lastGradeRow=null;
    function calc(){
      if(!salary) return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 };
      var base = clamp(toNum(salary.value));
      if(!(base>0)){
        st(deductTotal,'0'); st(netPay,'0'); st(vLB,'0'); st(vNH,'0'); st(vP,'0'); st(vWF,'0'); st(vTotal,'0'); st(vGrade,'â€”'); upChart([]); return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 };
      }
      var row = pickGradeBySalaryUp(base); lastGradeRow=row; st(vGrade, row.g.toLocaleString());
      var pAmt = Math.round(base * 6 / 100); var wfAmt = Math.round(base * 0.5 / 100);
      var lbAmt = row.lb; var nhAmt = row.nh;
      var totalDeduct = pAmt + lbAmt + nhAmt + wfAmt; var net = Math.max(0, base - totalDeduct);
      st(deductTotal, fmt(totalDeduct)); st(netPay, fmt(net));
      st(vLB, fmt(lbAmt)); st(vNH, fmt(nhAmt)); st(vP, fmt(pAmt)); st(vWF, fmt(wfAmt)); st(vTotal, fmt(totalDeduct));
      upChart([{k:'è‡ªæ6%',v:pAmt},{k:'å‹ä¿',v:lbAmt},{k:'å¥ä¿',v:nhAmt},{k:'ç¦åˆ©é‡‘',v:wfAmt}]);
      return { base:base, pAmt:pAmt, lbAmt:lbAmt, nhAmt:nhAmt, wfAmt:wfAmt, totalDeduct:totalDeduct, net:net };
    }
    function calcSafe(){ try{ return calc(); } catch(e){ return { base:0,pAmt:0,lbAmt:0,nhAmt:0,wfAmt:0,totalDeduct:0,net:0 }; } }

    // ===== è–ªè³‡ç´€éŒ„ï¼ˆlocalStorageï¼‰ =====
    var LS_KEY='paybook:records';
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return [] } }
    function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); }
    function render(){
      var arr = load().sort(function(a,b){ return (a.month||'').localeCompare(b.month||'') });
      list.innerHTML=''; if(arr.length===0){ list.innerHTML='<div class="footerNote">å°šç„¡ç´€éŒ„ï¼Œå¡«å¯«è–ªè³‡å¾ŒæŒ‰ã€Œæ–°å¢ï¼æ›´æ–°æœ¬æœˆç´€éŒ„ã€ã€‚</div>'; return; }
      for(var i=0;i<arr.length;i++){
        var rec=arr[i]; var div=document.createElement('div'); div.className='item';
        div.innerHTML = '<button class="trash">åˆªé™¤</button>'+
          '<h4>'+rec.month+'ï½œå¯¦é ˜ '+fmt(rec.net)+' å…ƒ</h4>'+
          '<div class="meta">è–ªè³‡ '+fmt(rec.base)+'ã€€å‹é€€è‡ªæ '+fmt(rec.pAmt)+'ã€€å‹ä¿ '+fmt(rec.lbAmt)+'ã€€å¥ä¿ '+fmt(rec.nhAmt)+'ã€€ç¦åˆ©é‡‘ '+fmt(rec.wfAmt)+'</div>'+
          '<div class="meta" style="margin-top:6px">æ‰£é™¤åˆè¨ˆï¼š'+fmt(rec.totalDeduct)+' å…ƒ</div>';
        div.querySelector('.trash').onclick=function(m){ return function(){ if(confirm('åˆªé™¤ '+m+' çš„ç´€éŒ„ï¼Ÿ')){ var all=load().filter(function(x){return x.month!==m}); save(all); render(); } } }(rec.month);
        div.onclick=function(r){ return function(e){ if(e.target.classList.contains('trash')) return; salary.value = r.base; calcSafe(); window.scrollTo({top:0,behavior:'smooth'}); } }(rec);
        list.appendChild(div);
      }
    }

    btnAdd.onclick=function(){ var m=new Date().toISOString().slice(0,7); var c=calcSafe(); var rec={month:m,base:c.base,pRate:6,pAmt:c.pAmt,lbAmt:c.lbAmt,nhAmt:c.nhAmt,wfRate:0.5,wfAmt:c.wfAmt,totalDeduct:c.totalDeduct,net:c.net}; var arr=load(); var i=arr.findIndex?arr.findIndex(function(x){return x.month===m}):-1; if(i>=0)arr[i]=rec; else arr.push(rec); save(arr); render(); };
    btnExport.onclick=function(){ var data=JSON.stringify(load(),null,2); var blob=new Blob([data],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='paybook-records.json'; a.click(); URL.revokeObjectURL(a.href); };
    fileImport.onchange=function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; var rd=new FileReader(); rd.onload=function(){ try{ var arr=JSON.parse(rd.result); if(arr&&arr.constructor===Array){ save(arr); render(); alert('åŒ¯å…¥å®Œæˆ'); } }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; rd.readAsText(f); };
    btnClearAll.onclick=function(){ if(confirm('ç¢ºå®šæ¸…ç©ºå…¨éƒ¨è–ªè³‡ç´€éŒ„ï¼Ÿ')){ save([]); render(); } };

    // ===== æ”¯å‡ºï¼ˆlocalStorageï¼‰ =====
    var LS_EXP='paybook:expenses';
    function loadExp(){ try{ return JSON.parse(localStorage.getItem(LS_EXP)||'[]'); }catch(e){ return [] } }
    function saveExp(arr){ localStorage.setItem(LS_EXP, JSON.stringify(arr)); }
    function monthOf(d){ return (d||new Date().toISOString().slice(0,10)).slice(0,7) }

    function renderExp(){
      var m = expMonth && expMonth.value ? expMonth.value : new Date().toISOString().slice(0,7);
      if(expMonth && !expMonth.value) expMonth.value = m;
      var arr = loadExp().filter(function(x){return x.month===m});
      listExp.innerHTML=''; var total=0, group={};
      for(var i=0;i<arr.length;i++){
        var it=arr[i]; total += Number(it.amt)||0; group[it.cat]=(group[it.cat]||0)+(Number(it.amt)||0);
        var div=document.createElement('div'); div.className='item';
        div.innerHTML = '<button class="trash">åˆªé™¤</button>'+
          '<h4>'+it.date+'ï½œ'+it.cat+' '+fmt(it.amt)+' å…ƒ</h4>'+
          '<div class="meta">'+(it.memo?it.memo:'â€”')+'</div>';
        div.querySelector('.trash').onclick=function(id){ return function(){ var all=loadExp().filter(function(x){return x.id!==id}); saveExp(all); renderExp(); } }(it.id);
        // è§¸æ§æ»‘å‹•åˆªé™¤ï¼ˆä¿ç•™ï¼‰
        ;(function(){ var sx=0,dx=0; div.addEventListener('touchstart',function(e){sx=e.changedTouches[0].clientX}); div.addEventListener('touchmove',function(e){dx=e.changedTouches[0].clientX-sx; div.style.transform='translateX('+Math.max(-80,Math.min(0,dx))+'px)'}); div.addEventListener('touchend',function(){div.style.transform='';}); })();
        listExp.appendChild(div);
      }
      st(expSum, fmt(total)); var payRec=load().find?load().find(function(r){return r.month===m}):null; var monthlyNet = payRec? payRec.net : calcSafe().net; st(expRemain, fmt(Math.max(0,(monthlyNet||0)-total))); expHint.textContent = payRec? ('ä»¥ '+m+' çš„è–ªè³‡å¯¦é ˜ '+fmt(monthlyNet)+' å…ƒè¨ˆç®—ã€‚') : 'å°šæœªå»ºç«‹è©²æœˆè–ªè³‡ç´€éŒ„ï¼Œæš«ä»¥ç›®å‰è–ªè³‡è¼¸å…¥è©¦ç®—å¯ç”¨é¤˜é¡ã€‚'; upExpChart(group);
    }

    btnAddExp.onclick=function(){ var d=expDate&&expDate.value?expDate.value:new Date().toISOString().slice(0,10); var m=monthOf(d); if(expMonth) expMonth.value=m; var amt=Number(expAmt&&expAmt.value?expAmt.value:0); if(!(amt>0)){ alert('è«‹è¼¸å…¥é‡‘é¡'); return; } var rec={id:Date.now()+''+Math.random().toString(16).slice(2), date:d, month:m, cat:(expCat&&expCat.value?expCat.value:'å…¶ä»–'), amt:amt, memo:(expMemo&&expMemo.value?expMemo.value:'')}; var arr=loadExp(); arr.push(rec); saveExp(arr); renderExp(); expAmt.value=''; expMemo.value=''; };
    btnClrExpMonth.onclick=function(){ var m=expMonth&&expMonth.value?expMonth.value:monthOf(); if(!confirm('åˆªé™¤ '+m+' çš„å…¨éƒ¨æ”¯å‡ºï¼Ÿ')) return; var arr=loadExp().filter(function(x){return x.month!==m}); saveExp(arr); renderExp(); };
    btnExportExp.onclick=function(){ var m=expMonth&&expMonth.value?expMonth.value:monthOf(); var data=JSON.stringify(loadExp().filter(function(x){return x.month===m}),null,2); var blob=new Blob([data],{type:'application/json'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='expenses-'+m+'.json'; a.click(); URL.revokeObjectURL(a.href); };
    fileImportExp.onchange=function(e){ var f=e.target.files&&e.target.files[0]; if(!f) return; var rd=new FileReader(); rd.onload=function(){ try{ var arr=JSON.parse(rd.result); if(arr&&arr.constructor===Array){ var all=loadExp().concat(arr); saveExp(all); renderExp(); alert('æ”¯å‡ºåŒ¯å…¥å®Œæˆ'); } }catch(err){ alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤'); } }; rd.readAsText(f); };

    // ===== äº‹ä»¶èˆ‡åˆå§‹åŒ– =====
    ;['input','change','keyup'].forEach(function(evt){ [salary].forEach(function(el){ if(el) el.addEventListener(evt, calcSafe); }); });
    // åˆæ¬¡è¼‰å…¥
    if(expMonth) expMonth.value = new Date().toISOString().slice(0,7);
    if(expDate)  expDate.value  = new Date().toISOString().slice(0,10);
    calcSafe(); render(); renderExp();
  </script>
</body>
</html>
