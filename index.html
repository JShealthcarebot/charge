<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨˜å¸³ Â· åœ“å½¢å‹•æ…‹æ¥µç°¡ v3.2ï¼ˆæ·±è‰²/ç»ç’ƒ/æ»‘å‹•ï¼‰</title>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+TC:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Charts & Excel (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f7fbfa;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --brand: #22b7a6;
      --brand-2: #60d1c6;
      --accent: #3da9f5;
      --danger: #ef4444;
      --ok: #10b981;
      --radius: 18px;
      --shadow: 0 10px 24px rgba(0,0,0,.08);
      --shadow-sm: 0 6px 14px rgba(0,0,0,.06);
      --line: #e9f0ef;
      --soft: #f0f7f6;
      --table-head: #f0faf7;
      --chip-exp: #ef4444;
      --chip-inc: #10b981;
      --canvas-grid: #d9e6e3;
    }
    body.dark{
      --bg: #0f1720;
      --card: #0f1b22;
      --text: #e5eef2;
      --muted: #98a4ab;
      --brand: #2ed3c6;
      --brand-2: #60d1c6;
      --accent: #69b8ff;
      --danger: #f87171;
      --ok: #34d399;
      --shadow: 0 10px 24px rgba(0,0,0,.35);
      --shadow-sm: 0 6px 14px rgba(0,0,0,.28);
      --line: #17303a;
      --soft: #0e2227;
      --table-head: #0e2329;
      --canvas-grid: #233943;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'PingFang TC', 'Microsoft JhengHei', Arial, sans-serif;
      letter-spacing:.2px;
      background:
        radial-gradient(1100px 520px at -10% -10%, rgba(232,251,245,.8) 0%, transparent 50%) no-repeat,
        radial-gradient(900px 480px at 110% 0%, rgba(234,245,255,.8) 0%, transparent 55%) no-repeat,
        linear-gradient(180deg, var(--bg), var(--soft));
      color: var(--text);
      transition: background .3s ease, color .2s ease;
    }
    body.dark{
      background:
        radial-gradient(1000px 500px at -20% -30%, rgba(29,71,69,.6) 0%, transparent 55%) no-repeat,
        radial-gradient(900px 520px at 120% -10%, rgba(29,50,83,.55) 0%, transparent 55%) no-repeat,
        linear-gradient(180deg, var(--bg), #0a1317);
    }
    .wrap{max-width: 1080px; margin: 26px auto 140px; padding: 0 16px;}
    .titleRow{display:flex; align-items:center; gap:14px; margin-bottom:14px}
    .logo{width:50px;height:50px;border-radius:50%;
      background: conic-gradient(from 210deg at 50% 50%, var(--brand), var(--accent), var(--brand-2), var(--brand));
      box-shadow: var(--shadow);
      position: relative; overflow:hidden;
    }
    .logo::after{content:''; position:absolute; inset:0; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), transparent 40%); mix-blend-mode: screen;}
    h1{font-size:22px; margin:0 0 2px; letter-spacing:.5px; font-weight:800}
    .tagline{color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns: 1fr; gap:16px}
    @media(min-width:900px){ .grid{grid-template-columns: 1.1fr .9fr} }

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px; border:1px solid var(--line); transition: background .25s ease, border-color .25s ease, box-shadow .25s ease}
    body.glass .card{
      background: rgba(255,255,255,.65);
      border: 1px solid rgba(255,255,255,.35);
      backdrop-filter: saturate(160%) blur(14px);
    }
    body.dark.glass .card{
      background: rgba(15, 27, 34, .55);
      border-color: rgba(255,255,255,.12);
      backdrop-filter: saturate(160%) blur(14px);
    }

    .card h2{margin:0 0 10px; font-size:18px; display:flex; align-items:center; gap:8px; font-weight:800}
    .chip{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; color:#fff; background:linear-gradient(135deg, var(--brand), var(--accent)); box-shadow:var(--shadow-sm)}

    .row{display:flex; flex-wrap:wrap; gap:10px}
    .row > *{flex:1 1 160px}
    label{font-size:12px; color:var(--muted); display:block; margin:2px 4px}
    input, select{
      width:100%; border:1px solid #e6ecea; background:#fbfefc;
      padding:10px 12px; border-radius:12px; outline:none; font-size:14px;
      position:relative; z-index:1; pointer-events:auto;
    }
    body.dark input, body.dark select{ background:#0a1317; border-color:#1f3640; color:var(--text); }
    input:focus, select:focus{border-color: var(--brand); box-shadow:0 0 0 3px rgba(34,183,166,.14)}

    .circle{
      --size:52px;
      width:var(--size); height:var(--size);
      border-radius:50%;
      display:inline-grid; place-items:center;
      color:#fff; border:none; cursor:pointer; user-select:none;
      background: linear-gradient(135deg, var(--brand), var(--accent));
      box-shadow: 0 10px 18px rgba(61,169,245,.25), inset 0 -2px 6px rgba(0,0,0,.12);
      transition: transform .12s ease, box-shadow .2s ease, filter .2s ease, background .2s ease;
      position:relative; overflow:hidden;
      font-weight:700;
    }
    .circle:hover{ transform: translateY(-2px) scale(1.02); filter: brightness(1.04); }
    .circle:active{ transform: translateY(0) scale(.97); }
    .circle.secondary{ background: linear-gradient(135deg, #60a5fa, #3b82f6); }
    .circle.ok{ background: linear-gradient(135deg, #34d399, #10b981); }
    .circle.danger{ background: linear-gradient(135deg, #f87171, #ef4444); }
    .circle.ghost{ background:#fff; color:var(--text); border:1px dashed #d1d5db; box-shadow: var(--shadow-sm); }
    body.dark .circle.ghost{ background:#0a1317; border-color:#2b3f47; color:var(--text); }

    .circle::before{ content:''; position:absolute; width:0; height:0; border-radius:50%; background: rgba(255,255,255,.35); left:50%; top:50%; transform:translate(-50%,-50%); opacity:0; }
    .circle:active::before{ width:160%; height:160%; opacity:1; transition: width .22s ease-out, height .22s ease-out, opacity .5s ease; }

    .mini{ --size:36px; font-size:14px }
    .toolrow{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px}

    .segs{display:flex; flex-wrap:wrap; gap:8px; margin-top:4px}
    .seg{ display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:999px; background:#f5fbfa; border:1px solid #e6f3f0; color:#0f766e; font-size:13px; cursor:pointer; transition:.15s; user-select:none; }
    body.dark .seg{ background:#0e2227; border-color:#17303a; color:#86e1d8; }
    .seg:hover{filter: brightness(1.03)}
    .seg.active{ background:linear-gradient(135deg, var(--brand), var(--accent)); color:#fff; border-color: transparent; box-shadow:var(--shadow-sm) }

    .stats{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:10px}
    .stat{background:#f6fbfa; border:1px solid #e6f3f0; border-radius:14px; padding:12px}
    body.dark .stat{ background:#0e2227; border-color:#17303a; }
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .val{font-weight:800; margin-top:2px; font-size:18px}

    .tableWrap{max-height: 420px; overflow:auto; border:1px solid var(--line); border-radius:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{position:sticky; top:0; background:var(--table-head); border-bottom:1px solid var(--line); padding:10px; font-weight:600}
    tbody td{border-bottom:1px solid rgba(0,0,0,.04); padding:10px; vertical-align:top}
    body.dark tbody td{border-bottom-color:#15262c}
    .typeChip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff}
    .chip-exp{background:var(--chip-exp)}
    .chip-inc{background:var(--chip-inc)}
    .ops{display:flex; gap:6px}

    tbody tr{ position:relative; touch-action: pan-y; transition: transform .2s ease; background: transparent; }
    .swipeActs{ position:absolute; right:8px; top:50%; transform:translateY(-50%); display:flex; gap:8px; opacity:0; pointer-events:none; }
    .swipe-open .swipeActs{ opacity:1; pointer-events:auto; }
    @media(max-width: 720px){ thead th:last-child, tbody td:last-child{ display:none; } }

    details{margin-top:12px}
    summary{cursor:pointer; padding:8px 12px; border-radius:12px; background:var(--table-head); border:1px solid var(--line); user-select:none}
    canvas{max-height: 320px}

    .fab-wrap{position:fixed; right:18px; bottom:18px; z-index:99}
    .fab-main{--size:64px; font-size:22px; background: radial-gradient(circle at 35% 30%, #fff6, transparent 40%), linear-gradient(135deg, var(--brand), var(--accent));}
    .fab-menu{position:absolute; right:8px; bottom:76px; display:grid; gap:10px; opacity:0; pointer-events:none; transform: translateY(8px); transition:.2s}
    .fab-wrap.open .fab-menu{opacity:1; pointer-events:auto; transform: translateY(0)}
    .fab-item{display:flex; align-items:center; gap:8px; justify-content:flex-end}
    .fab-label{background:#111827; color:#fff; font-size:12px; padding:6px 8px; border-radius:10px; box-shadow:var(--shadow-sm)}

    .panel{ position:fixed; top:16px; right:16px; z-index:100; width:min(92vw, 360px); display:none; }
    .panel.open{ display:block; }
    .panel .inner{ background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:var(--shadow); padding:12px }
    body.glass .panel .inner{ background: rgba(255,255,255,.75); backdrop-filter: blur(12px); }
    body.dark.glass .panel .inner{ background: rgba(15,27,34,.75); }
    .panel h3{ margin:4px 0 8px; font-size:14px }
    .panel .row{ gap:8px }
    .panel .close{ position:absolute; top:-6px; right:-6px }

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titleRow">
      <div class="logo"></div>
      <div>
        <h1>è¨˜å¸³ Â· åœ“å½¢å‹•æ…‹æ¥µç°¡ v3.2</h1>
        <div class="tagline" id="tagline">å°åœ“éˆ•ï¼Œå¤§æˆæ•ˆã€‚</div>
      </div>
      <div style="margin-left:auto">
        <button class="circle ghost mini" id="btnSettings" title="ä¸»é¡Œ / é¢¨æ ¼">âš™ï¸</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>æ–°å¢äº¤æ˜“ <span class="chip">åœ“å½¢æ“ä½œ</span></h2>
        <div class="row">
          <div>
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" />
          </div>
          <div>
            <label>æ”¶æ”¯</label>
            <select id="type">
              <option value="expense">æ”¯å‡º</option>
              <option value="income">æ”¶å…¥</option>
            </select>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <!-- é è¨­æ”¾å…¥åŸºæœ¬é¸é …ï¼Œç¢ºä¿ä¸€å®šå¯é» -->
            <select id="category">
              <option value="é£Ÿç‰©">é£Ÿç‰©</option>
              <option value="äº¤é€š">äº¤é€š</option>
              <option value="å¨›æ¨‚">å¨›æ¨‚</option>
              <option value="è³¼ç‰©">è³¼ç‰©</option>
              <option value="ä½æˆ¿">ä½æˆ¿</option>
              <option value="æ°´é›»ç“¦æ–¯">æ°´é›»ç“¦æ–¯</option>
              <option value="é†«ç™‚">é†«ç™‚</option>
              <option value="æ•™è‚²">æ•™è‚²</option>
              <option value="ç¨…é‡‘">ç¨…é‡‘</option>
              <option value="å…¶ä»–" selected>å…¶ä»–</option>
              <option value="è‡ªè¨‚åˆ†é¡â€¦">è‡ªè¨‚åˆ†é¡â€¦</option>
            </select>
          </div>
          <div>
            <label>å¸³æˆ¶</label>
            <select id="account">
              <option>ç¾é‡‘</option>
              <option>ä¿¡ç”¨å¡</option>
              <option>é‡‘èå¡</option>
              <option>é›»å­æ”¯ä»˜</option>
              <option>å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>é‡‘é¡ï¼ˆTWDï¼‰</label>
            <input type="number" id="amount" step="0.01" placeholder="0" />
          </div>
          <div style="flex:1 1 100%">
            <label>å‚™è¨»</label>
            <input type="text" id="note" placeholder="å¯è¼¸å…¥åº—å®¶ã€äº‹é …ã€æ¨™ç±¤â€¦" />
          </div>
        </div>
        <div class="toolrow">
          <button class="circle ok" id="btnAdd" data-title="æ–°å¢">â•</button>
          <button class="circle secondary" id="btnQuick" data-title="å¿«é€Ÿæ–°å¢ï¼šä»Šæ—¥é›¶ç”¨ $100">ğŸš€</button>
        </div>

        <hr style="border:none; border-top:1px solid var(--line); margin:12px 0">

        <h2>ç¯©é¸ / ç¸½è¦½</h2>
        <div class="row">
          <div>
            <label>é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="fStart" />
          </div>
          <div>
            <label>çµæŸæ—¥æœŸ</label>
            <input type="date" id="fEnd" />
          </div>
          <div>
            <label>æ”¶æ”¯</label>
            <select id="fType">
              <option value="all">å…¨éƒ¨</option>
              <option value="expense">æ”¯å‡º</option>
              <option value="income">æ”¶å…¥</option>
            </select>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <select id="fCategory"></select>
          </div>
          <div style="flex: 1 1 100%">
            <label>é—œéµå­—ï¼ˆå‚™è¨»/å¸³æˆ¶ï¼‰</label>
            <input type="text" id="fKeyword" placeholder="ä¾‹å¦‚ï¼šè¶…å•†ã€åˆé¤ã€æˆ¿ç§Ÿâ€¦" />
          </div>
        </div>
        <div class="toolrow">
          <button class="circle" id="btnFilter" title="å¥—ç”¨ç¯©é¸">ğŸ”</button>
          <button class="circle ghost" id="btnReset" title="æ¸…é™¤ç¯©é¸">â™»ï¸</button>
          <div class="segs" id="segWrap">
            <div class="seg" data-range="today">ä»Šæ—¥</div>
            <div class="seg active" data-range="month">æœ¬æœˆ</div>
            <div class="seg" data-range="year">ä»Šå¹´</div>
            <div class="seg" data-range="all">å…¨éƒ¨</div>
          </div>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="label">æ”¶å…¥ï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statInc">â€”</div>
          </div>
          <div class="stat">
            <div class="label">æ”¯å‡ºï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statExp">â€”</div>
          </div>
          <div class="stat">
            <div class="label">æ·¨é¡ï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statNet">â€”</div>
          </div>
        </div>

        <details id="chartsBox" open>
          <summary>åœ–è¡¨ï¼ˆåˆ†é¡åœ“é¤… / èµ°å‹¢æŠ˜ç·šï¼‰</summary>
          <div class="row" style="margin-top:10px">
            <div style="flex:1 1 280px"><canvas id="pie"></canvas></div>
            <div style="flex:1 1 280px"><canvas id="line"></canvas></div>
          </div>
        </details>

        <details id="recycleBin">
          <summary>å›æ”¶æ¡¶ / é‚„åŸ</summary>
          <div class="tableWrap" style="margin-top:10px">
            <table>
              <thead>
                <tr>
                  <th style="width:180px">æ™‚é–“</th>
                  <th>å…§å®¹</th>
                  <th style="width:240px">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody id="backupTbody"></tbody>
            </table>
          </div>
        </details>
      </div>

      <div class="card">
        <h2>äº¤æ˜“æ¸…å–® <span class="muted" id="listCount"></span></h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:100px">æ—¥æœŸ</th>
                <th style="width:80px">æ”¶æ”¯</th>
                <th>åˆ†é¡ / å¸³æˆ¶</th>
                <th style="width:120px">é‡‘é¡</th>
                <th>å‚™è¨»</th>
                <th style="width:106px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:8px">æç¤ºï¼šåˆªé™¤/æ¸…ç©º/å€é–“åˆªé™¤æœƒå…ˆä¸Ÿé€²ã€Œå›æ”¶æ¡¶ã€ï¼Œå¯éš¨æ™‚é‚„åŸæˆ–åŒ¯å‡ºã€‚æ‰‹æ©Ÿå¯å·¦å³æ»‘å‹•æ¯åˆ—å«å‡ºæ“ä½œã€‚</div>
      </div>
    </div>
    <div class="muted" style="text-align:center; margin:16px 0 6px">Made with ğŸŒ± Â· è³‡æ–™å­˜æ–¼ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚è‹¥è¦é›²ç«¯åŒæ­¥ï¼Œå¯å†æ¥ Firebaseã€‚</div>
  </div>

  <div class="panel" id="panel">
    <div class="inner">
      <button class="circle mini ghost close" id="btnClosePanel" title="é—œé–‰">âœ•</button>
      <h3>è‰²å½©æ¨¡å¼</h3>
      <div class="row segs" id="themeSeg">
        <div class="seg" data-theme="auto">è‡ªå‹•</div>
        <div class="seg" data-theme="light">æ·ºè‰²</div>
        <div class="seg" data-theme="dark">æ·±è‰²</div>
      </div>
      <h3 style="margin-top:12px">å¡ç‰‡é¢¨æ ¼</h3>
      <div class="row segs" id="styleSeg">
        <div class="seg" data-style="flat">æ‰å¹³</div>
        <div class="seg" data-style="glass">ç»ç’ƒ</div>
      </div>
    </div>
  </div>

  <div class="fab-wrap" id="fabWrap">
    <div class="fab-menu">
      <div class="fab-item">
        <div class="fab-label">åŒ¯å‡º Excelï¼ˆç›®å‰ç¯©é¸ï¼‰</div>
        <button class="circle secondary" id="btnExport" aria-label="åŒ¯å‡º">ğŸ“¤</button>
      </div>
      <div class="fab-item">
        <div class="fab-label">åŒ¯å…¥ Excel</div>
        <button class="circle secondary" id="btnImport" aria-label="åŒ¯å…¥">ğŸ“¥</button>
      </div>
      <div class="fab-item">
        <div class="fab-label">å‚™ä»½å…¨éƒ¨ï¼ˆJSONï¼‰</div>
        <button class="circle" id="btnBackup" aria-label="å‚™ä»½">ğŸ’¾</button>
      </div>
      <div class="fab-item">
        <div class="fab-label">åˆªé™¤ã€Œæ‰€é¸æ—¥æœŸå€é–“ã€</div>
        <button class="circle danger" id="btnDeleteRange" aria-label="åˆªé™¤å€é–“">ğŸ§¹</button>
      </div>
      <div class="fab-item">
        <div class="fab-label">æ¸…ç©ºå…¨éƒ¨</div>
        <button class="circle danger" id="btnClearAll" aria-label="æ¸…ç©º">ğŸ—‘ï¸</button>
      </div>
    </div>
    <button class="circle fab-main" id="menuFab" aria-label="åŠŸèƒ½">â˜°</button>
  </div>
  <input type="file" id="fileImport" accept=".xlsx,.xls" style="display:none" />

<script>
(function(){
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const fmtCurrency = (n) => new Intl.NumberFormat('zh-TW',{style:'currency', currency:'TWD', maximumFractionDigits:0}).format(n||0);
  const todayStr = () => new Date().toISOString().slice(0,10);
  const toISODate = (d) => new Date(d+'T00:00:00');

  const STORAGE_KEY = 'ledgerRecords@circle_v3_2';
  const BACKUP_KEY = 'ledgerBackups@circle_v3_2';
  const PREF_KEY = 'ledgerPrefs@circle_v3_2';

  const readStore = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const writeStore = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  const readBackups = () => JSON.parse(localStorage.getItem(BACKUP_KEY) || '[]');
  const writeBackups = (arr) => localStorage.setItem(BACKUP_KEY, JSON.stringify(arr));
  const readPrefs = () => JSON.parse(localStorage.getItem(PREF_KEY) || '{"theme":"auto","style":"flat"}');
  const writePrefs = (obj) => localStorage.setItem(PREF_KEY, JSON.stringify(obj));
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  const SLOGANS = [
    'è®“æ¯ä¸€å¡ŠéŒ¢éƒ½æœ‰å»è™•ã€‚',
    'è¨˜ä¸‹æ”¯å‡ºï¼Œä¹Ÿè¨˜ä¸‹ä½ çš„ç†æƒ³ã€‚',
    'ç©©ç©©è®Šæœ‰éŒ¢ï¼Œå¾ä»Šå¤©é–‹å§‹ã€‚',
    'èŠ±åœ¨åˆ€å£ä¸Šï¼Œå­˜åˆ°å¿ƒåè£¡ã€‚',
    'å°åœ“éˆ•ï¼Œå¤§æˆæ•ˆã€‚'
  ];

  const EXP_CAT = ['é£Ÿç‰©','äº¤é€š','å¨›æ¨‚','è³¼ç‰©','ä½æˆ¿','æ°´é›»ç“¦æ–¯','é†«ç™‚','æ•™è‚²','ç¨…é‡‘','å…¶ä»–'];
  const INC_CAT = ['è–ªè³‡','çé‡‘','æŠ•è³‡','é€€æ¬¾','å…¶ä»–'];

  const els = {
    date: $('#date'), type: $('#type'), category: $('#category'), account: $('#account'), amount: $('#amount'), note: $('#note'),
    btnAdd: $('#btnAdd'), btnQuick: $('#btnQuick'),
    fStart: $('#fStart'), fEnd: $('#fEnd'), fType: $('#fType'), fCategory: $('#fCategory'), fKeyword: $('#fKeyword'),
    btnFilter: $('#btnFilter'), btnReset: $('#btnReset'),
    statInc: $('#statInc'), statExp: $('#statExp'), statNet: $('#statNet'),
    tbody: $('#tbody'), listCount: $('#listCount'),
    btnExport: $('#btnExport'), btnImport: $('#btnImport'), fileImport: $('#fileImport'), btnBackup: $('#btnBackup'), btnDeleteRange: $('#btnDeleteRange'), btnClearAll: $('#btnClearAll'),
    pie: $('#pie'), line: $('#line'), chartsBox: $('#chartsBox'),
    tagline: $('#tagline'),
    fabWrap: $('#fabWrap'), menuFab: $('#menuFab'),
    segWrap: $('#segWrap'),
    btnSettings: $('#btnSettings'), panel: $('#panel'), btnClosePanel: $('#btnClosePanel'),
    themeSeg: $('#themeSeg'), styleSeg: $('#styleSeg')
  };

  // ------- ä¸»é¡Œ/é¢¨æ ¼ -------
  let prefs = readPrefs();
  const mediaDark = window.matchMedia('(prefers-color-scheme: dark)');
  mediaDark.addEventListener?.('change', ()=> applyTheme());
  function applyTheme(){
    const mode = prefs.theme || 'auto';
    const isDark = mode === 'dark' || (mode === 'auto' && mediaDark.matches);
    document.body.classList.toggle('dark', isDark);
    document.body.classList.toggle('glass', (prefs.style === 'glass'));
    $$('#themeSeg .seg').forEach(s=> s.classList.toggle('active', s.dataset.theme === mode));
    $$('#styleSeg .seg').forEach(s=> s.classList.toggle('active', s.dataset.style === prefs.style));
    if (window.Chart){
      Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--text').trim();
      Chart.defaults.borderColor = getComputedStyle(document.body).getPropertyValue('--canvas-grid').trim();
    }
    drawCharts(getFiltered());
  }
  els.btnSettings.addEventListener('click', ()=> els.panel.classList.add('open'));
  els.btnClosePanel.addEventListener('click', ()=> els.panel.classList.remove('open'));
  els.themeSeg.addEventListener('click', (e)=>{ const seg = e.target.closest('.seg'); if(!seg) return; prefs.theme = seg.dataset.theme; writePrefs(prefs); applyTheme(); });
  els.styleSeg.addEventListener('click', (e)=>{ const seg = e.target.closest('.seg'); if(!seg) return; prefs.style = seg.dataset.style; writePrefs(prefs); applyTheme(); });

  // åˆå§‹åŒ– UI
  els.date.value = todayStr();
  els.fEnd.value = todayStr();
  els.fStart.value = todayStr().slice(0,8) + '01';
  els.tagline.textContent = SLOGANS[Math.floor(Math.random()*SLOGANS.length)];
  els.chartsBox.open = true;
  applyTheme();

  function fillCategories(forTypeSel, catSel){
    const type = forTypeSel.value;
    const list = type === 'income' ? INC_CAT : EXP_CAT;
    const custom = 'è‡ªè¨‚åˆ†é¡â€¦';
    catSel.innerHTML = '';
    list.forEach((c)=>{ const opt = document.createElement('option'); opt.textContent = c; opt.value = c; catSel.appendChild(opt); });
    const optX = document.createElement('option'); optX.textContent = custom; optX.value = custom; catSel.appendChild(optX);
    if (!catSel.value || !list.includes(catSel.value)) catSel.value = list.includes('å…¶ä»–') ? 'å…¶ä»–' : list[0];
  }
  function safeInitCategories(){
    try{ fillCategories(els.type, els.category); }catch(e){}
    if(!els.category.options || els.category.options.length===0){
      ['é£Ÿç‰©','äº¤é€š','å¨›æ¨‚','è³¼ç‰©','ä½æˆ¿','æ°´é›»ç“¦æ–¯','é†«ç™‚','æ•™è‚²','ç¨…é‡‘','å…¶ä»–','è‡ªè¨‚åˆ†é¡â€¦'].forEach(c=>{
        const opt=document.createElement('option'); opt.value=c; opt.textContent=c; els.category.appendChild(opt);
      });
    }
  }
  function fillFilterCategories(){
    const all = Array.from(new Set(EXP_CAT.concat(INC_CAT)));
    els.fCategory.innerHTML = '';
    ['å…¨éƒ¨'].concat(all).forEach(c=>{
      const opt = document.createElement('option');
      opt.textContent = c; opt.value = c;
      els.fCategory.appendChild(opt);
    })
  }
  safeInitCategories();
  fillFilterCategories();

  els.type.addEventListener('change', ()=> fillCategories(els.type, els.category));
  ['focus','mousedown','click'].forEach(evt=>{
    els.category.addEventListener(evt, ()=>{
      if(!els.category.options || els.category.options.length<=1){ safeInitCategories(); }
    });
  });
  els.category.addEventListener('change', ()=>{
    if(els.category.value === 'è‡ªè¨‚åˆ†é¡â€¦'){
      const v = prompt('è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š');
      if(v && v.trim()){
        const t = els.type.value;
        (t==='income'?INC_CAT:EXP_CAT).push(v.trim());
        fillCategories(els.type, els.category);
        els.category.value = v.trim();
        fillFilterCategories();
      } else {
        fillCategories(els.type, els.category);
      }
    }
  });

  function addRecord(rec){ const store = readStore(); store.push(rec); writeStore(store); }
  function handleAdd(){
    const date = els.date.value; const type = els.type.value; const category = els.category.value; const account = els.account.value; const amount = parseFloat(els.amount.value); const note = els.note.value.trim();
    if(!date){ alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
    if(!category){ alert('è«‹é¸æ“‡åˆ†é¡'); return; }
    if(!(amount>0)){ alert('é‡‘é¡éœ€å¤§æ–¼ 0'); return; }
    const rec = { id: uid(), date, type, category, account, amount, note, createdAt: new Date().toISOString() };
    addRecord(rec); els.amount.value = ''; els.note.value = ''; pulse(els.btnAdd); refresh();
  }
  els.btnAdd.addEventListener('click', handleAdd);
  els.amount.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleAdd(); });
  els.btnQuick.addEventListener('click', ()=>{ els.type.value = 'expense'; safeInitCategories(); els.category.value = 'å…¶ä»–'; els.account.value = 'ç¾é‡‘'; els.amount.value = 100; els.note.value = 'é›¶ç”¨'; handleAdd(); });

  els.segWrap.addEventListener('click', (e)=>{ const seg = e.target.closest('.seg'); if(!seg) return; $$('#segWrap .seg').forEach(s=> s.classList.remove('active')); seg.classList.add('active'); const r = seg.getAttribute('data-range'); applyQuickRange(r); refresh(); });
  function applyQuickRange(kind){
    const d = new Date();
    if(kind==='today'){ const t = todayStr(); els.fStart.value = t; els.fEnd.value = t; }
    else if(kind==='month'){ const y = d.getFullYear(); const m = d.getMonth(); const first = new Date(y, m, 1); const last = new Date(y, m+1, 0); els.fStart.value = first.toISOString().slice(0,10); els.fEnd.value = last.toISOString().slice(0,10); }
    else if(kind==='year'){ const y = d.getFullYear(); els.fStart.value = `${y}-01-01`; els.fEnd.value = `${y}-12-31`; }
    else if(kind==='all'){ els.fStart.value = ''; els.fEnd.value = ''; }
  }

  function inRange(d, start, end){ const x = toISODate(d).getTime(); if(start && x < toISODate(start).getTime()) return false; if(end && x > toISODate(end).getTime()) return false; return true; }
  function getFiltered(){
    const store = readStore(); const t = els.fType.value; const c = els.fCategory.value; const kw = els.fKeyword.value.trim(); const s = els.fStart.value; const e = els.fEnd.value;
    let arr = store.filter(r=> inRange(r.date, s, e)); if(t !== 'all') arr = arr.filter(r=> r.type === t); if(c && c !== 'å…¨éƒ¨') arr = arr.filter(r=> r.category === c); if(kw) arr = arr.filter(r=> (r.note||'').includes(kw) || (r.account||'').includes(kw)); arr.sort((a,b)=> (a.date<b.date?1:a.date>b.date?-1: (a.createdAt<b.createdAt?1:-1)) ); return arr;
  }
  function refreshStats(list){ const inc = list.filter(r=> r.type==='income').reduce((s,r)=> s+r.amount,0); const exp = list.filter(r=> r.type==='expense').reduce((s,r)=> s+r.amount,0); els.statInc.textContent = fmtCurrency(inc); els.statExp.textContent = fmtCurrency(exp); els.statNet.textContent = fmtCurrency(inc - exp); }
  function renderTable(list){
    els.tbody.innerHTML = ''; els.listCount.textContent = `ï¼ˆ${list.length} ç­†ï¼‰`;
    if(list.length===0){ const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan=6; td.innerHTML = '<span class="muted">æœ¬æœŸé–“æ²’æœ‰è³‡æ–™</span>'; tr.appendChild(td); els.tbody.appendChild(tr); return; }
    for(const r of list){
      const tr = document.createElement('tr');
      const cDate = document.createElement('td'); cDate.textContent = r.date; tr.appendChild(cDate);
      const cType = document.createElement('td'); const chip = document.createElement('span'); chip.className='typeChip '+(r.type==='expense'?'chip-exp':'chip-inc'); chip.textContent = r.type==='expense'?'æ”¯å‡º':'æ”¶å…¥'; cType.appendChild(chip); tr.appendChild(cType);
      const cCat = document.createElement('td'); cCat.innerHTML = `<div>${r.category}</div><div class="muted" style="font-size:12px">${r.account||''}</div>`; tr.appendChild(cCat);
      const cAmt = document.createElement('td'); cAmt.style.textAlign='right'; cAmt.textContent = (r.type==='expense'?'-':'') + fmtCurrency(r.amount).replace('NT$',''); tr.appendChild(cAmt);
      const cNote = document.createElement('td'); cNote.textContent = r.note||''; tr.appendChild(cNote);
      const cOps = document.createElement('td'); cOps.className='ops';
      const bEdit = document.createElement('button'); bEdit.className='circle mini'; bEdit.title='ç·¨è¼¯'; bEdit.textContent='âœ'; bEdit.addEventListener('click', ()=> editRecord(r.id));
      const bDel = document.createElement('button'); bDel.className='circle mini danger'; bDel.title='åˆªé™¤'; bDel.textContent='ğŸ—‘ï¸'; bDel.addEventListener('click', ()=> deleteRecord(r.id));
      cOps.appendChild(bEdit); cOps.appendChild(bDel); tr.appendChild(cOps);
      const act = document.createElement('div'); act.className='swipeActs';
      const sEdit = document.createElement('button'); sEdit.className='circle mini'; sEdit.textContent='âœ'; sEdit.addEventListener('click', (ev)=>{ ev.stopPropagation(); editRecord(r.id); closeSwipe(tr); });
      const sDel  = document.createElement('button'); sDel.className='circle mini danger'; sDel.textContent='ğŸ—‘ï¸'; sDel.addEventListener('click', (ev)=>{ ev.stopPropagation(); deleteRecord(r.id); });
      act.appendChild(sEdit); act.appendChild(sDel); tr.appendChild(act);
      addSwipe(tr);
      els.tbody.appendChild(tr);
    }
  }

  function recKey(r){ return [r.date, r.type, r.category, r.account||'', r.amount||0, r.note||''].join('|'); }
  function saveBackup(data, label){ const arr = readBackups(); arr.push({ id: uid(), ts: new Date().toISOString(), label: label||'', data }); writeBackups(arr); refreshBackups(); }
  function editRecord(id){ const store = readStore(); const idx = store.findIndex(r=> r.id===id); if(idx<0) return; const r = store[idx]; const newAmt = prompt('è¼¸å…¥æ–°é‡‘é¡ï¼š', r.amount); if(newAmt===null) return; const num = parseFloat(newAmt); if(!(num>0)){ alert('é‡‘é¡éœ€å¤§æ–¼ 0'); return; } const newNote = prompt('ä¿®æ”¹å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', r.note||''); store[idx].amount = num; store[idx].note = (newNote||'').trim(); writeStore(store); refresh(); }
  function deleteRecord(id){ const store = readStore(); const rec = store.find(r=> r.id===id); if(!rec) return; saveBackup({ type:'single', records:[rec] }, `å–®ç­†_${rec.date}_${rec.category}`); if(!confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return; writeStore(store.filter(r=> r.id!==id)); refresh(); }
  function refreshBackups(){ const tbody = document.getElementById('backupTbody'); if(!tbody) return; const arr = readBackups().slice().sort((a,b)=> a.ts<b.ts?1:-1); tbody.innerHTML = ''; if(arr.length===0){ const tr = document.createElement('tr'); const td = document.createElement('td'); td.colSpan = 3; td.innerHTML = '<span class="muted">ç›®å‰æ²’æœ‰å‚™ä»½</span>'; tr.appendChild(td); tbody.appendChild(tr); return; } for(const b of arr){ const tr = document.createElement('tr'); const td1 = document.createElement('td'); td1.textContent = new Date(b.ts).toLocaleString(); tr.appendChild(td1); const count = (b.data && b.data.records) ? b.data.records.length : 0; const td2 = document.createElement('td'); td2.textContent = `${b.label || b.data.type || 'å‚™ä»½'}ï¼ˆ${count} ç­†ï¼‰`; tr.appendChild(td2); const td3 = document.createElement('td'); td3.style.width='240px'; const mkBtn=(txt, cls, fn)=>{ const btn=document.createElement('button'); btn.className='circle mini '+cls; btn.style.marginRight='6px'; btn.textContent=txt; btn.addEventListener('click', ()=> fn(b.id)); return btn; }; td3.appendChild(mkBtn('é‚„åŸ','ok', restoreBackup)); td3.appendChild(mkBtn('åŒ¯å‡º','secondary', exportBackup)); td3.appendChild(mkBtn('åˆªé™¤','danger', deleteBackup)); tr.appendChild(td3); tbody.appendChild(tr); } }
  function restoreBackup(id){ const arr = readBackups(); const b = arr.find(x=> x.id===id); if(!b) return; const recs = (b.data && b.data.records) ? b.data.records : []; const store = readStore(); const have = new Set(store.map(recKey)); let added = 0; for(const r of recs){ const k = recKey(r); if(!have.has(k)){ have.add(k); const rec = { ...r }; if(!rec.id) rec.id = uid(); if(!rec.createdAt) rec.createdAt = new Date().toISOString(); store.push(rec); added++; } } writeStore(store); alert(`å·²é‚„åŸ ${added} ç­†`); refresh(); }
  function exportBackup(id){ const arr = readBackups(); const b = arr.find(x=> x.id===id); if(!b) return; const name = b.label || b.data.type || 'data'; downloadJSON(`backup_${name}.json`, b.data); }
  function deleteBackup(id){ const arr = readBackups().filter(x=> x.id!==id); writeBackups(arr); refreshBackups(); }

  function exportExcel(){ const all = getFiltered(); if(all.length===0){ alert('ç›®å‰ç¯©é¸ç„¡è³‡æ–™å¯åŒ¯å‡º'); return; } const txRows = [['Date','Type','Category','Account','Amount','Note','ID']].concat(all.map(r=>[r.date, r.type, r.category, r.account||'', (r.type==='expense'?-r.amount:r.amount), r.note||'', r.id])); const monthAgg = {}; for(const r of all){ const m = r.date.slice(0,7); if(!monthAgg[m]) monthAgg[m] = {income:0, expense:0}; if(r.type==='income') monthAgg[m].income += r.amount; else monthAgg[m].expense += r.amount; } const sumRows = [['Month','Income','Expense','Net']].concat(Object.keys(monthAgg).sort().map(m=>[m, monthAgg[m].income, monthAgg[m].expense, monthAgg[m].income - monthAgg[m].expense])); const wb = XLSX.utils.book_new(); const ws1 = XLSX.utils.aoa_to_sheet(txRows); const ws2 = XLSX.utils.aoa_to_sheet(sumRows); XLSX.utils.book_append_sheet(wb, ws1, 'Transactions'); XLSX.utils.book_append_sheet(wb, ws2, 'MonthlySummary'); const fname = `ledger_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,16)}.xlsx`; XLSX.writeFile(wb, fname); }
  function importExcel(file){ const reader = new FileReader(); reader.onload = (e)=>{ const data = new Uint8Array(e.target.result); const wb = XLSX.read(data, {type:'array'}); const sheet = wb.Sheets['Transactions'] || wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(sheet, {defval:''}); if(json.length===0){ alert('æª”æ¡ˆæ²’æœ‰è³‡æ–™'); return; } const store = readStore(); const keyOf = (r)=> [r.date,r.type,r.category,r.account,(r.amount||0), (r.note||'')].join('|'); const existedKeys = new Set(store.map(keyOf)); let added = 0; for(const row of json){ const date = (row.Date||row['æ—¥æœŸ']||'').toString().slice(0,10); const type = (row.Type||row['æ”¶æ”¯']||'').toString().toLowerCase().includes('inc')? 'income' : ((row.Type||row['æ”¶æ”¯']||'')==='æ”¶å…¥'?'income':'expense'); const category = row.Category||row['åˆ†é¡']||'å…¶ä»–'; const account = row.Account||row['å¸³æˆ¶']||''; let amount = parseFloat(row.Amount||row['é‡‘é¡']||0); if(isNaN(amount)) amount = 0; if(amount<0){ amount = Math.abs(amount); } const note = row.Note||row['å‚™è¨»']||''; if(!date || !(amount>0)) continue; const tmp = {date, type, category, account, amount, note}; const k = keyOf(tmp); if(existedKeys.has(k)) continue; existedKeys.add(k); store.push({ id: uid(), ...tmp, createdAt: new Date().toISOString() }); added++; } writeStore(store); alert(`å·²åŒ¯å…¥ ${added} ç­†`); refresh(); }; reader.readAsArrayBuffer(file); }

  function deleteRange(){ const s = els.fStart.value, e = els.fEnd.value; if(!s && !e){ alert('è«‹å…ˆæŒ‡å®šé–‹å§‹/çµæŸæ—¥æœŸ'); return; } const store = readStore(); const toDel = store.filter(r=> inRange(r.date, s, e)); if(toDel.length===0){ alert('æ­¤å€é–“æ²’æœ‰è³‡æ–™'); return; } saveBackup({ type:'range', start:s||null, end:e||null, records: toDel }, `å€é–“_${s||'NA'}_${e||'NA'}`); if(!confirm(`ç¢ºèªåˆªé™¤ ${toDel.length} ç­†ï¼Ÿ`)) return; const remain = store.filter(r=> !inRange(r.date, s, e)); writeStore(remain); refresh(); }
  function clearAll(){ const store = readStore(); if(store.length===0){ alert('ç›®å‰æ²’æœ‰è³‡æ–™'); return; } saveBackup({ type:'all', records: store }, 'å…¨éƒ¨_æ¸…ç©º'); if(!confirm(`ç¢ºèªæ¸…ç©ºå…¨éƒ¨ ${store.length} ç­†ï¼Ÿ`)) return; writeStore([]); refresh(); }

  let pieChart=null, lineChart=null;
  function drawCharts(list){ if(typeof Chart === 'undefined'){ return; } const exp = list.filter(r=> r.type==='expense'); const pieMap = {}; for(const r of exp){ pieMap[r.category] = (pieMap[r.category]||0) + r.amount; } const labels = Object.keys(pieMap); const values = labels.map(k=> pieMap[k]); if(pieChart){ pieChart.destroy(); } pieChart = new Chart(els.pie, { type:'pie', data:{ labels, datasets:[{ data: values }] }, options:{ plugins:{ legend:{ position:'bottom' } } } }); const dayMap = {}; for(const r of list){ dayMap[r.date] = dayMap[r.date] || {inc:0, exp:0}; if(r.type==='income') dayMap[r.date].inc += r.amount; else dayMap[r.date].exp += r.amount; } const days = Object.keys(dayMap).sort(); const net = days.map(d=> dayMap[d].inc - dayMap[d].exp); if(lineChart){ lineChart.destroy(); } lineChart = new Chart(els.line, { type:'line', data:{ labels: days, datasets:[{ label:'æ—¥æ·¨é¡', data: net, tension:.25 }] }, options:{ scales:{ y:{ beginAtZero:true } } } }); }

  function downloadJSON(filename, obj){ const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); setTimeout(()=> URL.revokeObjectURL(url), 1500); }
  function backupAll(){ downloadJSON('backup_all.json', readStore()); }

  els.menuFab.addEventListener('click', ()=>{ els.fabWrap.classList.toggle('open'); spin(els.menuFab); });
  els.btnFilter.addEventListener('click', refresh);
  els.btnReset.addEventListener('click', ()=>{ els.fStart.value=''; els.fEnd.value=''; els.fType.value='all'; els.fCategory.value='å…¨éƒ¨'; els.fKeyword.value=''; $$('#segWrap .seg').forEach(s=>s.classList.remove('active')); refresh(); });
  els.btnExport.addEventListener('click', exportExcel);
  els.btnImport.addEventListener('click', ()=> els.fileImport.click());
  els.fileImport.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importExcel(f); e.target.value=''; });
  els.btnBackup.addEventListener('click', backupAll);
  els.btnDeleteRange.addEventListener('click', deleteRange);
  els.btnClearAll.addEventListener('click', clearAll);

  function refresh(){ const list = getFiltered(); renderTable(list); refreshStats(list); drawCharts(list); }

  function pulse(el){ el.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:280, easing:'ease-out'}); }
  function spin(el){ el.animate([{transform:'rotate(0deg)'},{transform:'rotate(180deg)'}],{duration:220, easing:'ease-out'}); }

  function addSwipe(tr){ let startX=0, curX=0, open=false, dragging=false; const max = 110; const onStart = (e)=>{ dragging=true; startX = (e.touches? e.touches[0].clientX : e.clientX); curX = 0; tr.style.transition='none'; }; const onMove = (e)=>{ if(!dragging) return; const x = (e.touches? e.touches[0].clientX : e.clientX); const dx = x - startX; curX = Math.max(-max, Math.min(0, dx + (open?-max:0))); tr.style.transform = `translateX(${curX}px)`; }; const onEnd = ()=>{ if(!dragging) return; dragging=false; tr.style.transition='transform .2s ease'; const shouldOpen = (open ? curX < -60 : curX < -40); open = shouldOpen; if(open){ tr.classList.add('swipe-open'); tr.style.transform=`translateX(${-max}px)`; } else { closeSwipe(tr); } }; tr.addEventListener('touchstart', onStart, {passive:true}); tr.addEventListener('touchmove', onMove, {passive:true}); tr.addEventListener('touchend', onEnd); tr.addEventListener('mousedown', onStart); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onEnd); tr.addEventListener('click', ()=>{ if(open){ closeSwipe(tr); } }); }
  function closeSwipe(tr){ tr.classList.remove('swipe-open'); tr.style.transform='translateX(0)'; }

  refresh();
  refreshBackups();
})();
</script>
</body>
</html>
