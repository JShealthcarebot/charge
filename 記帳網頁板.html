<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è¨˜å¸³ç¶²é æ¿ Â· ç°¡æ½”ç‰ˆ</title>
  <!-- åœ–è¡¨ & Excel -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg: #f4f9f7;           /* æŸ”å’Œæ·¡ç¶ åº• */
      --card: #ffffff;         /* å¡ç‰‡ç™½ */
      --brand: #34b3a0;        /* ä¸»è‰²(è‡ªç„¶ç¶ ) */
      --brand-2: #7cc7be;      /* æ¬¡è‰²(æ·ºç¶ ) */
      --accent: #3da9f5;       /* å¼·èª¿(å¤©ç©ºè—) */
      --text: #1f2937;         /* ä¸»è¦æ–‡å­— */
      --muted: #6b7280;        /* æ¬¡è¦æ–‡å­— */
      --danger: #ef4444;       /* åˆªé™¤ç´… */
      --ok: #10b981;           /* æˆåŠŸç¶  */
      --radius: 18px;          /* å¾®åœ“è§’ */
      --shadow: 0 10px 24px rgba(0,0,0,.08);
    }
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', 'PingFang TC', Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg), #eaf6f3);
      color: var(--text);
    }
    .wrap{max-width: 980px; margin: 28px auto; padding: 0 16px;}
    .titleRow{display:flex; align-items:center; gap:12px; margin-bottom:14px}
    .logo{width:42px;height:42px; border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--brand-2)); box-shadow:var(--shadow)}
    h1{font-size:22px; margin:0; letter-spacing:.5px}
    .tagline{color:var(--muted); font-size:13px}

    .grid{display:grid; grid-template-columns: 1fr; gap:14px}
    @media(min-width:880px){ .grid{grid-template-columns: 1.1fr .9fr} }

    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px}
    .card h2{margin:0 0 10px; font-size:18px}

    .row{display:flex; flex-wrap:wrap; gap:10px}
    .row > *{flex:1 1 160px}
    label{font-size:12px; color:var(--muted); display:block; margin:2px 4px}
    input, select, textarea, button{
      width:100%; box-sizing:border-box; border:1px solid #e6ecea; background:#fbfefc;
      padding:10px 12px; border-radius:12px; outline:none; font-size:14px;
    }
    input:focus, select:focus, textarea:focus{border-color: var(--brand)}

    .btn{cursor:pointer; border:none; color:#fff; background:linear-gradient(135deg,var(--brand),var(--accent));
      transition:transform .06s ease, box-shadow .2s ease; box-shadow:0 6px 14px rgba(61,169,245,.25);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn-secondary{background:linear-gradient(135deg,#93c5fd,#60a5fa)}
    .btn-danger{background:linear-gradient(135deg,#f87171,#ef4444)}
    .btn-ghost{background:#fff; color:var(--text); border:1px dashed #d1d5db}

    .stats{display:grid; grid-template-columns: repeat(3,1fr); gap:10px; margin-top:8px}
    .stat{background:#f6fbfa; border:1px solid #e6f3f0; border-radius:14px; padding:10px 12px}
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .val{font-weight:700; margin-top:4px}

    .tools{display:flex; flex-wrap:wrap; gap:10px; margin-top:10px}

    .tableWrap{max-height: 360px; overflow:auto; border:1px solid #edf2f1; border-radius:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    thead th{position:sticky; top:0; background:#f0faf7; border-bottom:1px solid #e6ecea; padding:10px}
    tbody td{border-bottom:1px solid #f2f4f3; padding:10px; vertical-align:top}
    .typeChip{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; color:#fff}
    .chip-exp{background:#ef4444}
    .chip-inc{background:#10b981}
    .ops{display:flex; gap:6px}

    details{margin-top:10px}
    summary{cursor:pointer; padding:8px 12px; border-radius:10px; background:#f0faf7; border:1px solid #e6ecea}
    canvas{max-height: 320px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="titleRow">
      <div class="logo"></div>
      <div>
        <h1>è¨˜å¸³ç¶²é æ¿ Â· ç°¡æ½”ç‰ˆ</h1>
        <div class="tagline" id="tagline">è®“æ¯ä¸€å¡ŠéŒ¢éƒ½æœ‰å»è™•ã€‚</div>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ï¼šæ–°å¢ / ç¯©é¸ / ç¸½è¦½ -->
      <div class="card">
        <h2>æ–°å¢äº¤æ˜“</h2>
        <div class="row">
          <div>
            <label>æ—¥æœŸ</label>
            <input type="date" id="date" />
          </div>
          <div>
            <label>æ”¶æ”¯</label>
            <select id="type">
              <option value="expense">æ”¯å‡º</option>
              <option value="income">æ”¶å…¥</option>
            </select>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <select id="category"></select>
          </div>
          <div>
            <label>å¸³æˆ¶</label>
            <select id="account">
              <option>ç¾é‡‘</option>
              <option>ä¿¡ç”¨å¡</option>
              <option>é‡‘èå¡</option>
              <option>é›»å­æ”¯ä»˜</option>
              <option>å…¶ä»–</option>
            </select>
          </div>
          <div>
            <label>é‡‘é¡ï¼ˆTWDï¼‰</label>
            <input type="number" id="amount" step="0.01" placeholder="0" />
          </div>
          <div style="flex: 1 1 100%">
            <label>å‚™è¨»</label>
            <input type="text" id="note" placeholder="å¯è¼¸å…¥åº—å®¶ã€äº‹é …ã€æ¨™ç±¤â€¦" />
          </div>
        </div>
        <div class="tools">
          <button class="btn" id="btnAdd">ï¼‹ æ–°å¢</button>
          <button class="btn-ghost" id="btnQuick">ä»Šæ—¥é›¶ç”¨ $100</button>
        </div>

        <hr style="border:none; border-top:1px dashed #e5e7eb; margin:14px 0">

        <h2>ç¯©é¸ / ç¸½è¦½</h2>
        <div class="row">
          <div>
            <label>é–‹å§‹æ—¥æœŸ</label>
            <input type="date" id="fStart" />
          </div>
          <div>
            <label>çµæŸæ—¥æœŸ</label>
            <input type="date" id="fEnd" />
          </div>
          <div>
            <label>æ”¶æ”¯</label>
            <select id="fType">
              <option value="all">å…¨éƒ¨</option>
              <option value="expense">æ”¯å‡º</option>
              <option value="income">æ”¶å…¥</option>
            </select>
          </div>
          <div>
            <label>åˆ†é¡</label>
            <select id="fCategory"><!-- å‹•æ…‹å¡«å…¥ --></select>
          </div>
          <div style="flex: 1 1 100%">
            <label>é—œéµå­—ï¼ˆå‚™è¨»/å¸³æˆ¶ï¼‰</label>
            <input type="text" id="fKeyword" placeholder="ä¾‹å¦‚ï¼šè¶…å•†ã€åˆé¤ã€æˆ¿ç§Ÿâ€¦" />
          </div>
        </div>
        <div class="tools">
          <button class="btn" id="btnFilter">å¥—ç”¨ç¯©é¸</button>
          <button class="btn-secondary" id="btnReset">æ¸…é™¤ç¯©é¸</button>
        </div>

        <div class="stats">
          <div class="stat">
            <div class="label">æ”¶å…¥ï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statInc">â€”</div>
          </div>
          <div class="stat">
            <div class="label">æ”¯å‡ºï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statExp">â€”</div>
          </div>
          <div class="stat">
            <div class="label">æ·¨é¡ï¼ˆæœŸé–“ï¼‰</div>
            <div class="val" id="statNet">â€”</div>
          </div>
        </div>

        <div class="tools">
          <button class="btn" id="btnExport">åŒ¯å‡º Excel</button>
          <input type="file" id="fileImport" accept=".xlsx,.xls" style="display:none" />
          <button class="btn-secondary" id="btnImport">åŒ¯å…¥ Excel</button>
          <button class="btn-ghost" id="btnBackup">å‚™ä»½ JSON</button>
          <button class="btn-danger" id="btnDeleteRange">åˆªé™¤ã€Œæ‰€é¸æ—¥æœŸå€é–“ã€</button>
          <button class="btn-danger" id="btnClearAll">æ¸…ç©ºå…¨éƒ¨</button>
        </div>

        <details id="chartsBox">
          <summary>å±•é–‹åœ–è¡¨ï¼ˆåˆ†é¡åœ“é¤… / èµ°å‹¢æŠ˜ç·šï¼‰</summary>
          <div class="row" style="margin-top:10px">
            <div style="flex:1 1 280px"><canvas id="pie"></canvas></div>
            <div style="flex:1 1 280px"><canvas id="line"></canvas></div>
          </div>
        </details>
      </div>

      <!-- å³ï¼šæ¸…å–® -->
      <div class="card">
        <h2>äº¤æ˜“æ¸…å–® <span class="muted" id="listCount"></span></h2>
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th style="width:100px">æ—¥æœŸ</th>
                <th style="width:80px">æ”¶æ”¯</th>
                <th>åˆ†é¡ / å¸³æˆ¶</th>
                <th style="width:120px">é‡‘é¡</th>
                <th>å‚™è¨»</th>
                <th style="width:96px">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <div class="muted" style="margin-top:8px">å°æé†’ï¼šé»ã€Œâœã€å¯å¿«é€Ÿç·¨è¼¯é‡‘é¡èˆ‡å‚™è¨»ï¼Œåˆªé™¤å‰æœƒè‡ªå‹•ä¸‹è¼‰å‚™ä»½ã€‚</div>
      </div>
    </div>

    <div class="muted" style="text-align:center; margin:16px 0 6px">Made with ğŸŒ± Â· æœ¬é é¢è³‡æ–™åªå­˜æ–¼ä½ çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ã€‚</div>
  </div>

<script>
(function(){
  // ---------- å·¥å…· ----------
  const $ = (sel) => document.querySelector(sel);
  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
  const fmtCurrency = (n) => new Intl.NumberFormat('zh-TW',{style:'currency', currency:'TWD', maximumFractionDigits:0}).format(n||0);
  const todayStr = () => new Date().toISOString().slice(0,10);
  const toISODate = (d) => new Date(d+'T00:00:00');

  const STORAGE_KEY = 'ledgerRecords@simple';
  const readStore = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  const writeStore = (arr) => localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  const uid = () => Math.random().toString(36).slice(2)+Date.now().toString(36);

  const SLOGANS = [
    'è®“æ¯ä¸€å¡ŠéŒ¢éƒ½æœ‰å»è™•ã€‚',
    'è¨˜ä¸‹æ”¯å‡ºï¼Œä¹Ÿè¨˜ä¸‹ä½ çš„ç†æƒ³ã€‚',
    'ç©©ç©©è®Šæœ‰éŒ¢ï¼Œå¾ä»Šå¤©é–‹å§‹ã€‚',
    'èŠ±åœ¨åˆ€å£ä¸Šï¼Œå­˜åˆ°å¿ƒåè£¡ã€‚',
  ];

  // ---------- åˆ†é¡ ----------
  const EXP_CAT = ['é£Ÿç‰©','äº¤é€š','å¨›æ¨‚','è³¼ç‰©','ä½æˆ¿','æ°´é›»ç“¦æ–¯','é†«ç™‚','æ•™è‚²','ç¨…é‡‘','å…¶ä»–'];
  const INC_CAT = ['è–ªè³‡','çé‡‘','æŠ•è³‡','é€€æ¬¾','å…¶ä»–'];

  const els = {
    date: $('#date'), type: $('#type'), category: $('#category'), account: $('#account'), amount: $('#amount'), note: $('#note'),
    btnAdd: $('#btnAdd'), btnQuick: $('#btnQuick'),
    fStart: $('#fStart'), fEnd: $('#fEnd'), fType: $('#fType'), fCategory: $('#fCategory'), fKeyword: $('#fKeyword'),
    btnFilter: $('#btnFilter'), btnReset: $('#btnReset'),
    statInc: $('#statInc'), statExp: $('#statExp'), statNet: $('#statNet'),
    tbody: $('#tbody'), listCount: $('#listCount'),
    btnExport: $('#btnExport'), btnImport: $('#btnImport'), fileImport: $('#fileImport'), btnBackup: $('#btnBackup'), btnDeleteRange: $('#btnDeleteRange'), btnClearAll: $('#btnClearAll'),
    pie: $('#pie'), line: $('#line'), chartsBox: $('#chartsBox'),
    tagline: $('#tagline')
  };

  // åˆå§‹åŒ– UI
  els.date.value = todayStr();
  els.fEnd.value = todayStr();
  els.fStart.value = todayStr().slice(0,8) + '01'; // æœ¬æœˆ1è™Ÿ
  els.tagline.textContent = SLOGANS[Math.floor(Math.random()*SLOGANS.length)];

  function fillCategories(forTypeSel, catSel){
    const type = forTypeSel.value;
    const list = type === 'income' ? INC_CAT : EXP_CAT;
    catSel.innerHTML = '';
    list.concat(['è‡ªè¨‚åˆ†é¡â€¦']).forEach((c)=>{
      const opt = document.createElement('option');
      opt.textContent = c; opt.value = c;
      catSel.appendChild(opt);
    });
  }
  function fillFilterCategories(){
    const all = Array.from(new Set(EXP_CAT.concat(INC_CAT)));
    els.fCategory.innerHTML = '';
    ['å…¨éƒ¨'].concat(all).forEach(c=>{
      const opt = document.createElement('option');
      opt.textContent = c; opt.value = c;
      els.fCategory.appendChild(opt);
    })
  }
  fillCategories(els.type, els.category);
  fillFilterCategories();

  els.type.addEventListener('change', ()=> fillCategories(els.type, els.category));
  els.category.addEventListener('change', ()=>{
    if(els.category.value === 'è‡ªè¨‚åˆ†é¡â€¦'){
      const v = prompt('è¼¸å…¥æ–°çš„åˆ†é¡åç¨±ï¼š');
      if(v && v.trim()){
        const t = els.type.value;
        (t==='income'?INC_CAT:EXP_CAT).push(v.trim());
        fillCategories(els.type, els.category);
        els.category.value = v.trim();
        fillFilterCategories();
      } else {
        fillCategories(els.type, els.category);
      }
    }
  });

  // æ–°å¢äº¤æ˜“
  function addRecord(rec){
    const store = readStore();
    store.push(rec);
    writeStore(store);
  }

  function handleAdd(){
    const date = els.date.value;
    const type = els.type.value;
    const category = els.category.value;
    const account = els.account.value;
    const amount = parseFloat(els.amount.value);
    const note = els.note.value.trim();

    if(!date){ alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
    if(!category){ alert('è«‹é¸æ“‡åˆ†é¡'); return; }
    if(!(amount>0)){ alert('é‡‘é¡éœ€å¤§æ–¼ 0'); return; }

    const rec = { id: uid(), date, type, category, account, amount, note, createdAt: new Date().toISOString() };
    addRecord(rec);

    // æ¸…ç©ºé‡‘é¡èˆ‡å‚™è¨»ï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
    els.amount.value = '';
    els.note.value = '';

    refresh();
  }

  els.btnAdd.addEventListener('click', handleAdd);
  els.amount.addEventListener('keydown', (e)=>{ if(e.key==='Enter') handleAdd(); });
  els.btnQuick.addEventListener('click', ()=>{
    els.type.value = 'expense'; fillCategories(els.type, els.category);
    els.category.value = 'å…¶ä»–';
    els.account.value = 'ç¾é‡‘';
    els.amount.value = 100;
    els.note.value = 'é›¶ç”¨';
    handleAdd();
  });

  // ç¯©é¸ & è¨ˆç®—
  function inRange(d, start, end){
    const x = toISODate(d).getTime();
    if(start && x < toISODate(start).getTime()) return false;
    if(end && x > toISODate(end).getTime()) return false;
    return true;
  }

  function getFiltered(){
    const store = readStore();
    const t = els.fType.value;               // all / expense / income
    const c = els.fCategory.value;           // å…¨éƒ¨ / â€¦
    const kw = els.fKeyword.value.trim();
    const s = els.fStart.value; const e = els.fEnd.value;

    let arr = store.filter(r=> inRange(r.date, s, e));
    if(t !== 'all') arr = arr.filter(r=> r.type === t);
    if(c && c !== 'å…¨éƒ¨') arr = arr.filter(r=> r.category === c);
    if(kw) arr = arr.filter(r=> (r.note||'').includes(kw) || (r.account||'').includes(kw));

    // ä¾ æ—¥æœŸ DESC, å»ºç«‹æ™‚é–“ DESC
    arr.sort((a,b)=> (a.date<b.date?1:a.date>b.date?-1: (a.createdAt<b.createdAt?1:-1)) );
    return arr;
  }

  function refreshStats(list){
    const inc = list.filter(r=> r.type==='income').reduce((s,r)=> s+r.amount,0);
    const exp = list.filter(r=> r.type==='expense').reduce((s,r)=> s+r.amount,0);
    els.statInc.textContent = fmtCurrency(inc);
    els.statExp.textContent = fmtCurrency(exp);
    els.statNet.textContent = fmtCurrency(inc - exp);
  }

  function renderTable(list){
    els.tbody.innerHTML = '';
    els.listCount.textContent = `ï¼ˆ${list.length} ç­†ï¼‰`;

    if(list.length===0){
      const tr = document.createElement('tr');
      const td = document.createElement('td'); td.colSpan=6; td.innerHTML = '<span class="muted">æœ¬æœŸé–“æ²’æœ‰è³‡æ–™</span>';
      tr.appendChild(td); els.tbody.appendChild(tr); return;
    }

    for(const r of list){
      const tr = document.createElement('tr');
      const cDate = document.createElement('td'); cDate.textContent = r.date; tr.appendChild(cDate);
      const cType = document.createElement('td');
      const chip = document.createElement('span'); chip.className='typeChip '+(r.type==='expense'?'chip-exp':'chip-inc'); chip.textContent = r.type==='expense'?'æ”¯å‡º':'æ”¶å…¥';
      cType.appendChild(chip); tr.appendChild(cType);
      const cCat = document.createElement('td'); cCat.innerHTML = `<div>${r.category}</div><div class="muted" style="font-size:12px">${r.account||''}</div>`; tr.appendChild(cCat);
      const cAmt = document.createElement('td'); cAmt.style.textAlign='right'; cAmt.textContent = (r.type==='expense'?'-':'') + fmtCurrency(r.amount).replace('NT$',''); tr.appendChild(cAmt);
      const cNote = document.createElement('td'); cNote.textContent = r.note||''; tr.appendChild(cNote);

      const cOps = document.createElement('td'); cOps.className='ops';
      const bEdit = document.createElement('button'); bEdit.className='btn'; bEdit.style.padding='6px 10px'; bEdit.textContent='âœ';
      bEdit.addEventListener('click', ()=> editRecord(r.id));
      const bDel = document.createElement('button'); bDel.className='btn-danger'; bDel.style.padding='6px 10px'; bDel.textContent='åˆª';
      bDel.addEventListener('click', ()=> deleteRecord(r.id));
      cOps.appendChild(bEdit); cOps.appendChild(bDel); tr.appendChild(cOps);

      els.tbody.appendChild(tr);
    }
  }

  // ç·¨è¼¯ & åˆªé™¤
  function editRecord(id){
    const store = readStore();
    const idx = store.findIndex(r=> r.id===id); if(idx<0) return;
    const r = store[idx];
    const newAmt = prompt('è¼¸å…¥æ–°é‡‘é¡ï¼š', r.amount);
    if(newAmt===null) return;
    const num = parseFloat(newAmt); if(!(num>0)){ alert('é‡‘é¡éœ€å¤§æ–¼ 0'); return; }
    const newNote = prompt('ä¿®æ”¹å‚™è¨»ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', r.note||'');
    store[idx].amount = num; store[idx].note = (newNote||'').trim();
    writeStore(store);
    refresh();
  }

  function downloadJSON(filename, obj){
    const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=filename; a.click();
    setTimeout(()=> URL.revokeObjectURL(url), 2000);
  }

  function deleteRecord(id){
    const store = readStore();
    const rec = store.find(r=> r.id===id);
    if(!rec) return;
    // åˆªé™¤å‰è‡ªå‹•å‚™ä»½å–®ç­†
    downloadJSON(`backup_${rec.date}_${rec.category}.json`, rec);
    if(!confirm('ç¢ºå®šåˆªé™¤é€™ç­†ç´€éŒ„ï¼Ÿ')) return;
    writeStore(store.filter(r=> r.id!==id));
    refresh();
  }

  // åŒ¯å‡º Excel
  function exportExcel(){
    const all = getFiltered(); // åŒ¯å‡ºç›®å‰ç¯©é¸çµæœ
    if(all.length===0){ alert('ç›®å‰ç¯©é¸ç„¡è³‡æ–™å¯åŒ¯å‡º'); return; }

    const txRows = [['Date','Type','Category','Account','Amount','Note','ID']]
      .concat(all.map(r=>[r.date, r.type, r.category, r.account||'', (r.type==='expense'?-r.amount:r.amount), r.note||'', r.id]));

    // æœˆçµ
    const monthAgg = {};
    for(const r of all){
      const m = r.date.slice(0,7);
      if(!monthAgg[m]) monthAgg[m] = {income:0, expense:0};
      if(r.type==='income') monthAgg[m].income += r.amount; else monthAgg[m].expense += r.amount;
    }
    const sumRows = [['Month','Income','Expense','Net']].concat(
      Object.keys(monthAgg).sort().map(m=>[m, monthAgg[m].income, monthAgg[m].expense, monthAgg[m].income - monthAgg[m].expense])
    );

    const wb = XLSX.utils.book_new();
    const ws1 = XLSX.utils.aoa_to_sheet(txRows);
    const ws2 = XLSX.utils.aoa_to_sheet(sumRows);
    XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
    XLSX.utils.book_append_sheet(wb, ws2, 'MonthlySummary');
    const fname = `ledger_${new Date().toISOString().replace(/[:T]/g,'-').slice(0,16)}.xlsx`;
    XLSX.writeFile(wb, fname);
  }

  // åŒ¯å…¥ Excelï¼ˆTransactions å·¥ä½œè¡¨ï¼‰
  function importExcel(file){
    const reader = new FileReader();
    reader.onload = (e)=>{
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, {type:'array'});
      const sheet = wb.Sheets['Transactions'] || wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {defval:''});
      if(json.length===0){ alert('æª”æ¡ˆæ²’æœ‰è³‡æ–™'); return; }
      const store = readStore();

      // ä»¥ key å»é‡ï¼ˆæ—¥æœŸ+é¡å‹+åˆ†é¡+å¸³æˆ¶+é‡‘é¡+å‚™è¨»ï¼‰
      const keyOf = (r)=> [r.date,r.type,r.category,r.account,(r.amount||0), (r.note||'')].join('|');
      const existedKeys = new Set(store.map(keyOf));

      let added = 0;
      for(const row of json){
        // æ”¯æ´æ¬„ä½åç¨±ï¼šDate/æ—¥æœŸ, Type/æ”¶æ”¯, Category/åˆ†é¡, Account/å¸³æˆ¶, Amount/é‡‘é¡, Note/å‚™è¨»
        const date = (row.Date||row['æ—¥æœŸ']||'').toString().slice(0,10);
        const type = (row.Type||row['æ”¶æ”¯']||'').toString().toLowerCase().includes('inc')? 'income' : ((row.Type||row['æ”¶æ”¯']||'')==='æ”¶å…¥'?'income':'expense');
        const category = row.Category||row['åˆ†é¡']||'å…¶ä»–';
        const account = row.Account||row['å¸³æˆ¶']||'';
        let amount = parseFloat(row.Amount||row['é‡‘é¡']||0);
        if(isNaN(amount)) amount = 0;
        // è‹¥ Amount ç‚ºè² ï¼Œè¦–ç‚ºæ”¯å‡º
        if(amount<0){ amount = Math.abs(amount); }
        const note = row.Note||row['å‚™è¨»']||'';

        if(!date || !(amount>0)) continue;
        const tmp = {date, type, category, account, amount, note};
        const k = keyOf(tmp);
        if(existedKeys.has(k)) continue; // è·³éé‡è¤‡
        existedKeys.add(k);
        store.push({ id: uid(), ...tmp, createdAt: new Date().toISOString() });
        added++;
      }
      writeStore(store);
      alert(`å·²åŒ¯å…¥ ${added} ç­†`);
      refresh();
    };
    reader.readAsArrayBuffer(file);
  }

  // åˆªé™¤å€é–“ / æ¸…ç©º
  function deleteRange(){
    const s = els.fStart.value, e = els.fEnd.value;
    if(!s && !e){ alert('è«‹å…ˆæŒ‡å®šé–‹å§‹/çµæŸæ—¥æœŸ'); return; }
    const store = readStore();
    const toDel = store.filter(r=> inRange(r.date, s, e));
    if(toDel.length===0){ alert('æ­¤å€é–“æ²’æœ‰è³‡æ–™'); return; }
    downloadJSON(`backup_range_${s||'NA'}_${e||'NA'}.json`, toDel);
    if(!confirm(`ç¢ºèªåˆªé™¤ ${toDel.length} ç­†ï¼Ÿ`)) return;
    const remain = store.filter(r=> !inRange(r.date, s, e));
    writeStore(remain);
    refresh();
  }
  function clearAll(){
    const store = readStore();
    if(store.length===0){ alert('ç›®å‰æ²’æœ‰è³‡æ–™'); return; }
    downloadJSON('backup_all.json', store);
    if(!confirm(`ç¢ºèªæ¸…ç©ºå…¨éƒ¨ ${store.length} ç­†ï¼Ÿ`)) return;
    writeStore([]); refresh();
  }

  // åœ–è¡¨
  let pieChart=null, lineChart=null;
  function drawCharts(list){
    // Pieï¼ˆåƒ…è¨ˆç®—æ”¯å‡ºåˆ†é¡å æ¯”ï¼‰
    const exp = list.filter(r=> r.type==='expense');
    const pieMap = {};
    for(const r of exp){ pieMap[r.category] = (pieMap[r.category]||0) + r.amount; }
    const labels = Object.keys(pieMap);
    const values = labels.map(k=> pieMap[k]);

    if(pieChart){ pieChart.destroy(); }
    pieChart = new Chart(els.pie, {
      type:'pie', data:{ labels, datasets:[{ data: values }] }, options:{ plugins:{ legend:{ position:'bottom' } } }
    });

    // Lineï¼ˆæ—¥æ·¨é¡ï¼šæ”¶å…¥-æ”¯å‡ºï¼‰
    const dayMap = {};
    for(const r of list){
      dayMap[r.date] = dayMap[r.date] || {inc:0, exp:0};
      if(r.type==='income') dayMap[r.date].inc += r.amount; else dayMap[r.date].exp += r.amount;
    }
    const days = Object.keys(dayMap).sort();
    const net = days.map(d=> dayMap[d].inc - dayMap[d].exp);

    if(lineChart){ lineChart.destroy(); }
    lineChart = new Chart(els.line, {
      type:'line', data:{ labels: days, datasets:[{ label:'æ—¥æ·¨é¡', data: net, tension:.25 }] }, options:{ scales:{ y:{ beginAtZero:true } } }
    });
  }

  // å‚™ä»½ JSONï¼ˆå…¨éƒ¨ï¼‰
  function backupAll(){ downloadJSON('backup_all.json', readStore()); }

  // äº‹ä»¶ç¶å®š
  els.btnFilter.addEventListener('click', refresh);
  els.btnReset.addEventListener('click', ()=>{ els.fStart.value=''; els.fEnd.value=''; els.fType.value='all'; els.fCategory.value='å…¨éƒ¨'; els.fKeyword.value=''; refresh(); });
  els.btnExport.addEventListener('click', exportExcel);
  els.btnImport.addEventListener('click', ()=> els.fileImport.click());
  els.fileImport.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(f) importExcel(f); e.target.value=''; });
  els.btnBackup.addEventListener('click', backupAll);
  els.btnDeleteRange.addEventListener('click', deleteRange);
  els.btnClearAll.addEventListener('click', clearAll);

  function refresh(){
    const list = getFiltered();
    renderTable(list);
    refreshStats(list);
    if(els.chartsBox.open){ drawCharts(list); }
  }

  // åˆæ¬¡æ¸²æŸ“
  refresh();
})();
</script>
</body>
</html>
